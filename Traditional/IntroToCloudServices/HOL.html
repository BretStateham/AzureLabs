<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Markdown Preview</title>
<style>
body{font-family:helvetica, arial, freesans, clean, sans-serif;color:#333;line-height:1.6;font-size:14px}.markdown-body{line-height:1.6;font-size:14px}.markdown-body > *:first-child{margin-top:0 !important}.markdown-body > *:last-child{margin-bottom:0 !important}.markdown-body a.absent{color:#c00}.markdown-body h1{font-weight:700;-webkit-font-smoothing:antialiased;color:#000;font-size:28px;margin:20px 0 10px;padding:0}.markdown-body h2{font-weight:700;-webkit-font-smoothing:antialiased;color:#000;font-size:24px;border-bottom-color:#ccc;border-bottom-width:1px;border-bottom-style:solid;margin:20px 0 10px;padding:0}.markdown-body h3{font-weight:700;-webkit-font-smoothing:antialiased;font-size:18px;margin:20px 0 10px;padding:0}.markdown-body h4{font-weight:700;-webkit-font-smoothing:antialiased;font-size:16px;margin:20px 0 10px;padding:0}.markdown-body h5{font-weight:700;-webkit-font-smoothing:antialiased;font-size:14px;margin:20px 0 10px;padding:0}.markdown-body h6{font-weight:700;-webkit-font-smoothing:antialiased;color:#777;font-size:14px;margin:20px 0 10px;padding:0}.markdown-body blockquote{color:#777;border-left-color:#ddd;border-left-width:4px;border-left-style:solid;margin:15px 0;padding:0 15px}.markdown-body dl{margin:15px 0;padding:0}.markdown-body table{border-collapse:collapse;margin:15px 0;padding:0}.markdown-body pre{border-radius:3px;border:1px solid #ccc;line-height:19px;overflow:auto;font-size:13px;background-color:#f8f8f8;margin:15px 0;padding:6px 10px}.markdown-body li p.first{display:inline-block}.markdown-body dl dt{font-size:14px;font-style:italic;font-weight:700;margin:15px 0 5px;padding:0}.markdown-body dl dt:first-child{padding:0}.markdown-body dl dd{margin:0 0 15px;padding:0 15px}.markdown-body table tr{border-top-color:#ccc;border-top-width:1px;border-top-style:solid;background-color:#fff;margin:0;padding:0}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%}.markdown-body span.frame{overflow:hidden;display:block}.markdown-body span.frame > span{border:1px solid #ddd;width:auto;overflow:hidden;float:left;display:block;margin:13px 0 0;padding:7px}.markdown-body span.frame span img{float:left;display:block}.markdown-body span.frame span span{color:#333;clear:both;display:block;padding:5px 0 0}.markdown-body span.align-center > span{text-align:center;overflow:hidden;display:block;margin:13px auto 0}.markdown-body span.align-center span img{text-align:center;margin:0 auto}.markdown-body span.align-right > span{text-align:right;overflow:hidden;display:block;margin:13px 0 0}.markdown-body span.align-right span img{text-align:right;margin:0}.markdown-body span.float-left{overflow:hidden;margin-right:13px;float:left;display:block}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{overflow:hidden;margin-left:13px;float:right;display:block}.markdown-body span.float-right > span{text-align:right;overflow:hidden;display:block;margin:13px auto 0}.markdown-body pre > code{border:currentColor;white-space:pre;margin:0;padding:0}.markdown-body .highlight pre{border-radius:3px;border:1px solid #ccc;line-height:19px;overflow:auto;font-size:13px;background-color:#f8f8f8;padding:6px 10px}.markdown-body p,.markdown-body li{margin:15px 0}.markdown-body ul,.markdown-body ol{padding-left:30px;margin:15px 0}.markdown-body > h2:first-child,.markdown-body > h1:first-child,.markdown-body > h1:first-child + h2{border:0 currentColor;padding-top:0;margin-top:0}.markdown-body > h3:first-child,.markdown-body > h4:first-child,.markdown-body > h5:first-child,.markdown-body > h6:first-child{padding-top:0;margin-top:0}.markdown-body h1 + p,.markdown-body h2 + p,.markdown-body h3 + p,.markdown-body h4 + p,.markdown-body h5 + p,.markdown-body h6 + p,.markdown-body ul li > :first-child,.markdown-body ol li > :first-child,.markdown-body dl dt > :first-child,.markdown-body dl dd > :first-child,.markdown-body blockquote > :first-child,.markdown-body table tr th > :first-child,.markdown-body table tr td > :first-child{margin-top:0}.markdown-body ul li > :last-child,.markdown-body ol li > :last-child,.markdown-body dl dt > :last-child,.markdown-body dl dd > :last-child,.markdown-body blockquote > :last-child,.markdown-body table tr th > :last-child,.markdown-body table tr td > :last-child{margin-bottom:0}.markdown-body table tr th,.markdown-body table tr td{border:1px solid #ccc;text-align:left;margin:0;padding:6px 13px}.markdown-body span.align-center,.markdown-body span.align-right{overflow:hidden;clear:both;display:block}.markdown-body code,.markdown-body tt{border-radius:3px;border:1px solid #eaeaea;white-space:nowrap;background-color:#f8f8f8;margin:0 2px;padding:0 5px}.markdown-body pre code,.markdown-body pre tt{border:currentColor;background-color:transparent}span.codelanguage{display:none}
</style>
</head>
<body>
<div class="markdown-body">
<p><a name="IntroToCloudServices"></a></p>

<h1 id="Introduction_to_Cloud_Services">Introduction to Cloud Services</h1>

<hr>

<p><a name="Overview"></a></p>

<h2 id="Overview">Overview</h2>

<p>There are many ways you can run code in Azure.  The choice you make depends on what kind of control you need over the base operating system, and what kind of workloads you need to run.  One of the ways you can run code in Azure is in a <strong>&quot;Cloud Service&quot;</strong> using one or more <strong>&quot;Web Role&quot;</strong> or <strong>&quot;Worker Role&quot;</strong> virtual machine instances.</p>

<p>&quot;Web Role&quot; virtual machines are <strong>Windows Servers (you can pick which version) with IIS installed</strong>, whereas <strong>&quot;Worker Role&quot; virtual machines are Windows Servers <em>without</em> IIS installed</strong>. The great thing about Web Roles is that YOU don't need to maintain the operating systems or virtual machines.  Azure guarantess that the VMs are up to date, and will automatically replace them with fresh versions if they fail.  </p>

<p>A cloud service often consists of one or more web roles and/or worker roles, each with its own application files and configuration. Web roles provide a dedicated Internet Information Services (IIS) web server that can be used for hosting the web front-end of your cloud service. Application code hosted within worker roles can run tasks in the background that are asynchronous, long-running, or perpetual.</p>

<p>The other thing you need to understand about &quot;Web Role&quot; and &quot;Worker Role&quot; virtual machines is that they are <strong>&quot;stateless&quot;</strong>. That means that if the Azure fabric controler (the software that runs the Azure Data Center) needs to <strong>recycle or replace your role VM, the data that was placed there while it was running will be lost</strong>.  BUT THAT IS A GOOD THING.  That means that as long as you <strong>store your data and configuration off the virtual machine</strong> (like in Azure Storage or in an Azure SQL Database) you can access it from any role instance. The other great thing then is that you can run as many copies of your role instances as you like!  </p>

<p>To develop your application, you can develop locally on your workstation using the Compute and Storage emulators that ship with the Azure SDK.  You then create configuration information that tells the Fabric Controller what kind of role instances you need, and which code you have developed goes on which instances.  You bundle all of your compliled code and configuration information into a &quot;Package&quot; and send it up to the Azure Fabric Controller in the data center of your choice.  The fabric controller then reads the configuration, spins up the necessary Web Role and Worker Role instances, deploys your code to them, then monitors them all to make sure they are healthy! By creating a cloud service, you can deploy a multi-tier application in Windows Azure, defining multiple roles to distribute processing and allow flexible scaling of your application.</p>

<p><img src="images/0010webworker.jpg?raw=true" alt="webworker">
</p>

<p><em>Web Roles and Worker Roles</em></p>

<p>Storage services provide storage in the cloud, which includes Blob services for storing text and binary data, Table services for structured storage that can be queried, and Queue services for reliable and persistent messaging between services.</p>

<p>In this hands-on lab, you will explore the basic elements of an Azure Cloud Service by creating a simple GuestBook application that demonstrates many features of web and worker roles, blob storage, table storage, and queues.</p>

<p><img src="Images/0020storage01.jpg?raw=true" alt="Creating a new Windows Azure Cloud Service project" title="Creating a new Windows Azure Cloud Service project">
</p>

<p><em>Windows Azure Storage</em></p>

<p>The images in our application will be stored as blobs.</p>

<p><img src="Images/0030blobs.jpg?raw=true" alt="Creating a new Windows Azure Cloud Service project" title="Creating a new Windows Azure Cloud Service project">
</p>

<p><em>Blobs are collections that live in containers</em></p>

<p>In the GuestBook application, a web role provides the front-end that allows users to view the contents of the guest book and submit new entries. Each entry contains a name, a message, and an associated picture. The application also contains a worker role that can generate thumbnails for the images that users submit.</p>

<p>The logic looks like this:</p>

<p><img src="images/0040architecture.jpg?raw=true" alt="architecture">
</p>

<p>When users post a new item, the web role uploads the picture to blob storage and creates an entry in table storage that contains the information entered by the user and a link to the blob with the picture. The web role renders this information to the browser so users can view the contents of the guest book.</p>

<p>After storing the image and creating the entry, the web role posts a work item to a queue to have the image processed. The worker role fetches the work item from the queue, retrieves the image from blob storage, and resizes it to create a thumbnail. Using queues to post work items is a common pattern in cloud applications and enables the separation of compute-bound tasks from the front-end. The advantage of this approach is that front and back ends can be scaled independently.</p>

<p>The finished solution will look something like this:</p>

<ul>
<li>Configuration Project</li>
<li>Web Role</li>
<li>Worker Role</li>
<li>Shared Data Library (GuestBook_Data)</li>
</ul>

<p><img src="images/0050solutionoverview.png?raw=true" alt="0050SolutionOverview" title="Solution Overview">
</p>

<p><a name="Objectives"></a></p>

<h3 id="Objectives">Objectives</h3>

<p>In this hands-on lab, you will learn how to:</p>

<ul>
<li>Create applications in Azure using web roles and worker roles</li>
<li>Use Storage services including blobs, queues and tables</li>
<li>Publish an application to Windows Azure Cloud Services</li>
</ul>

<p><a name="Prerequisites"></a></p>

<h3 id="Prerequisites">Prerequisites</h3>

<p>The following is required to complete this hands-on lab and what I used to run through this lab:</p>

<ul>
<li>Windows 8.1</li>
<li>Visual Studio 2013</li>
<li><p><a href="http://go.microsoft.com/fwlink/p/?linkid=323510&clcid=0x409">Visual Studio 2013 Azure SDK and Tooling</a></p></li>
<li><p>IIS Setup on Windows 8.1</p>

<ul>
<li>In the search box, enter &quot;turn Windows features on or off,&quot; and then tap or click <strong>Turn Windows features on or off</strong> . </li>
<li>In the list of Windows features, select <strong>Internet Information Services</strong>, and then tap or click <strong>OK</strong>.</li>
<li>In the list of Windows features, tap or click the plus sign (+) next to <strong>Internet Information Services</strong>, tap or click the plus sign (+) next to <strong>World Wide Web Services</strong>, tap or click the plus sign (+) next to <strong>Application Development Features</strong>, select the dynamic content features you want to install, and then tap or click <strong>OK</strong>.</li>
</ul></li>
</ul>

<p><a name="UsingCodeSnippets"></a></p>

<h3 id="Using_the_Code_Snippets">Using the Code Snippets</h3>

<p>Code snippets are not needed. Everything you need is in this post. Just copy and paste as needed.</p>

<hr>

<p><a name="Exercises"></a></p>

<h2 id="Exercises">Exercises</h2>

<p>This hands-on lab includes the following exercises:</p>

<ol>
<li><p><a href="#Exercise1">Building Your First Windows Azure Application</a></p></li>
<li><p><a href="#Exercise2">Background Processing with Worker Roles and Queues</a></p></li>
<li><p><a href="#Exercise3">Publishing a Windows Azure Application</a></p></li>
</ol>

<p>Estimated time to complete this lab: <strong>120</strong> minutes.</p>
<blockquote>
<p><strong>Note:</strong> Each exercise is accompanied by a starting solution located in the Begin folder of the exercise that allows you to follow each exercise independently of the others. Please be aware that the code snippets that are added during an exercise are missing from these starting solutions and that they will not necessarily work until you complete the exercise. Inside the source code for an exercise, you will also find an End folder containing a Visual Studio solution with the code that results from completing the steps in the corresponding exercise. You can use these solutions as guidance if you need additional help as you work through this hands-on lab.</p>
</blockquote>
<p><a name="Exercise1"></a></p>

<h3 id="Exercise_1_Building_Your_First_Windows_Azure_Application">Exercise 1: Building Your First Windows Azure Application</h3>

<p>In this exercise, you create a guest book application and execute it in the local development fabric (emulators). For this purpose, you will use the Windows Azure Tools for Microsoft Visual Studio to create the project using the Cloud Service project template. These tools extend Visual Studio to enable the creation, building and running of Windows Azure services. You will continue to work with this project throughout the remainder of the lab.</p>

<p><a name="Ex1Task1"></a></p>

<h4 id="Task_1__Creating_the_Visual_Studio_Project">Task 1 – Creating the Visual Studio Project</h4>

<p>In this task, you create a new Cloud Service project in Visual Studio.</p>

<ol>
<li><p>Open <strong>Microsoft Visual Studio 2013</strong> <strong><em>as administrator</em></strong> by right clicking (while holding down the <strong>Shift</strong> key if the shortcut is on the taskbar) the <strong>Visual Studio 2013</strong> shortcut and choosing <strong>Run as administrator</strong>.</p></li>
<li><p>If the <strong>User Account Control</strong> dialog appears, click <strong>Yes</strong>.</p></li>
<li><p>From the <strong>Visual Studio</strong> menu bar, select <strong>File</strong> | <strong>New</strong> | <strong>Project...</strong>.  </p></li>
<li><p>In the <strong>New Project dialog</strong>, expand <strong>Visual C#</strong> in the <strong>Installed</strong> list and select <strong>Cloud</strong>. Choose the <strong>Windows Azure Cloud Service</strong> template, set the Name of the project to <strong>GuestBook</strong>, the location to the &quot;Begin&quot; folder for this lab <strong>\Source\Begin</strong>, and ensure that <strong>Create directory for solution</strong> is checked. Click <strong>OK</strong> to create the project.</p>

<p><img src="images/1010newcloudserviceproject.png?raw=true" alt="1010NewCloudServiceProject" title="New GuestBook Cloud Project">
</p>

<p><em>Creating a new Windows Azure Cloud Service project</em></p></li>
<li><p>In the <strong>New Windows Azure Cloud Service</strong> dialog, inside the <strong>Roles</strong> panel, expand the <strong>Visual C#</strong> tab. Select <strong>ASP.NET Web Role</strong> from the list of available roles and click the arrow <strong>(&gt;)</strong> to add an instance of this role to the solution. Before closing the dialog, select the new role in the right panel, <strong>click the pencil icon and rename the role</strong> as <strong>GuestBook_WebRole</strong>. Click <strong>OK</strong> to create the cloud service solution.</p>

<p><img src="images/1020guestbookwebrole.png?raw=true" alt="1020GuestBookWebRole">
</p>

<p><em>Assigning roles to a Cloud Service project</em></p></li>
<li><p>Select <strong>Web Forms</strong>, and click <strong>OK</strong>.</p>

<p><img src="images/1030webforms.png?raw=true" alt="1030WebForms" title="Web Forms">
</p>

<p><em>Selecting the Web Forms Template</em></p></li>
<li><p>In <strong>Solution Explorer</strong>, review the structure of the created solution.</p>

<p><img src="images/1040newsolution.png?raw=true" alt="1040NewSolution" title="New Solution">
</p>

<p><em>Solution Explorer showing the GuestBook application</em></p>
<blockquote>
<p><strong>Note:</strong> The generated solution contains two separate projects. The first project, named <strong>GuestBook</strong>, holds the configuration for the web and worker roles that compose the cloud application. It includes the service definition file, <strong>ServiceDefinition.csdef</strong>, which contains metadata needed by the Windows Azure fabric to understand the requirements of your application, such as which roles are used, their trust level, the endpoints exposed by each role, the local storage requirements and the certificates used by the roles. The service definition also establishes configuration settings specific to the application. The service configuration files (<strong>ServiceConfiguration.Local.cscfg</strong> and <strong>ServiceConfiguration.Cloud.cscfg</strong>) specify the number of instances to run for each role and sets the value of configuration settings defined in the service definition file. This separation between service definition and configuration allows you to update the settings of a running application by uploading a new service configuration file.</p>

<p>In Summary, two projects: (1) Configuration Project; (2) Actual Web Project.</p>

<p>You can create many configuration files, each one intended for a specific scenario such as production, development, or QA, and select which to use when publishing the application. By default, Visual Studio creates two files <strong>ServiceConfiguration.Local.cscfg</strong> and <strong>ServiceConfiguration.Cloud.cscfg</strong>.</p>

<p>The Roles node in the cloud service project enables you to configure which roles the service includes (web, worker or both) as well as which projects to associate with these roles. Adding and configuring roles through the Roles node will update the <strong>ServiceDefinition.csdef</strong> and <strong>ServiceConfiguration.cscfg</strong> files.</p>

<p>The second project, named <strong>GuestBook_WebRole</strong>, is a standard ASP.NET Web Application project template modified for the Windows Azure environment. It contains references to the Azure SDK libraries as well as an additional class that provides the entry point for the web role and contains methods to manage the initialization, starting, and stopping of the role.</p>
</blockquote></li>
</ol>

<p><a name="Ex1Task2"></a>  </p>

<h4 id="Task_2__Creating_a_Data_Model_for_Entities_in_Table_Storage">Task 2 – Creating a Data Model for Entities in Table Storage</h4>

<p>The application stores guest book entries in Table storage. The Table service offers semi-structured storage in the form of tables that contain collections of entities. Entities have a primary key and a set of properties, where a property is a name, typed-value pair. </p>

<p>In addition to the properties required by your model, every entity in Table Storage has three key properties: the <strong>PartitionKey</strong> and the <strong>RowKey</strong>. These properties together form the table's primary key and uniquely identify each entity in the table. Entities also have a <strong>Timestamp</strong> system property, which allows the service to keep track of when an entity was last modified. This field is intended for system use and should not be accessed by the application.
The Table Storage client API provides a <strong>TableServiceEntity</strong> class that defines the necessary properties. Although you can use the <strong>TableServiceEntity</strong> class as the base class for your entities, this is not required.</p>

<p>The Table service API is compliant with the REST API provided by <a href="http://msdn.microsoft.com/en-us/library/cc668792.aspx">WCF Data Services</a> (formerly ADO.NET Data Services Framework) allowing you to use the <a href="http://msdn.microsoft.com/en-us/library/cc668772.aspx">WCF Data Services Client Library</a> (formerly .NET Client Library) to work with data in Table Storage using .NET objects.</p>

<p>The Table service does not enforce any schema for tables making it possible for two entities in the same table to have different sets of properties. Nevertheless, the GuestBook application uses a fixed schema to store its data. </p>

<p>In order to use the WCF Data Services Client Library to access data in table storage, you need to create a context class that derives from <strong>TableServiceContext</strong>, which itself derives from <strong>DataServiceContext</strong> in WCF Data Services. The Table Storage API allows applications to create the tables that they use from these context classes. For this to happen, the context class must expose each required table as a property of type <strong>IQueryable&lt;SchemaClass&gt;</strong>, where <strong>SchemaClass</strong> is the class that models the entities stored in the table. </p>

<p>In this task, you model the schema of the entities stored by the GuestBook application and create a context class to use WCF Data Services to access the information in table storage. To complete the task, you create an object that can be data bound to data controls in ASP.NET and implements the basic data access operations: read, update, and delete.</p>

<ol>
<li><p>Create a new project for the schema classes. To create the project, right-click the <strong>GuestBook</strong> solution, point to <strong>Add</strong> and then select <strong>New Project</strong>.</p>

<p><img src="images/1040addnewproject.png?raw=true" alt="1050AddNewProject" title="Add New Project">
</p>

<p><em>Add New Project</em></p></li>
<li><p>In the <strong>Add New Project</strong> dialog, expand <strong>&quot;Installed&quot;</strong> | <strong>&quot;Visual C#&quot;</strong> and select the <strong>Windows Desktop</strong> category, and then choose the <strong>Class Library</strong> project template. Set the name to <strong><em>GuestBook_Data</em></strong>, leave the proposed location inside the solution folder unchanged, and then click <strong>OK</strong>.</p>

<p><img src="images/1060guestbookdata.png?raw=true" alt="1060GuestBook_Data" title="GuestBook_Data Project">
</p>

<p><em>Creating a class library for GuestBook entities</em></p></li>
<li><p>Delete the default class file generated by the class library template. To do this, <strong>right-click</strong> <strong>Class1.cs</strong> and choose <strong>Delete</strong>. Click <strong>OK</strong> in the confirmation dialog.</p>

<p><img src="images/1070deleteclass1.png?raw=true" alt="1070DeleteClass1" title="Delete Class1.cs">
</p>

<p><em>Delete Class1.cs</em></p></li>
<li><p>Next, we'll add some references to the <strong>GuestBook_Data</strong> project. In <strong>Solution Explorer</strong>, expand the <strong>GuestBook_Data</strong> project node, <strong>right-click</strong> the <strong>References</strong> node, and select <strong>Add Reference...</strong></p>

<p><img src="images/1080addreference.png?raw=true" alt="1080AddReference" title="Add Reference">
</p>

<p><em>Add Reference</em></p></li>
<li><p>In the <strong>Reference Manager - GuestBook_Data</strong> window, click the <strong>Extensions</strong> tab, select the <strong>Microsoft.Data.Services.Client</strong> assembly.  You will likely see multiple entries for the <strong>&quot;Microsoft.Data.Services.Client&quot; assembly, hover over each to find the one that is part of the Azure SDK, turn on the checkbox next to that one, and click **&quot;OK&quot;</strong>: </p>

<p><img src="images/1090dataservicesclient.png?raw=true" alt="1090DataServicesClient" title="Data Services Client Reference">
</p>

<p><em>Adding a reference to the System.Data.Service.Client component</em></p></li>
<li><p>Again, right click the <strong>GuestBook_Data</strong> | <strong>References</strong>, node, and select <strong>Add Reference...&quot;.  This time, in the **Reference Manager - GuestBook_Data</strong> window, switch to the <strong>Extensions</strong> page, select the following assemblies, and click <strong>OK</strong>:</p>

<ul>
<li><strong>Microsoft.WindowsAzure.Storage</strong></li>
<li><strong>Microsoft.WindowsAzure.Configuration</strong></li>
</ul>

<p><img src="images/1100azurereferences.png?raw=true" alt="1100AzureReferences" title="Azure Library References">
</p>

<p><em>Adding a reference to the Microsoft.WindowsAzure.Storage and Microsoft.WindowsAzure.Configuration component</em></p>
<blockquote>
<p><strong>Note:</strong> You may see multiple versions of the libraries if more than one version of the Azure SDK has been installed over time.  You can hover over an assembly to verify the path for the assembly points to the latest version.  </p>
</blockquote></li>
<li><p>Before you can store an entity in a table, you must first define its schema. To do this, right-click <strong>GuestBook_Data</strong> in <strong>Solution Explorer</strong>, point to <strong>Add</strong> and select <strong>Class</strong>. In the <strong>Add New Item</strong> dialog, set the name to <strong>GuestBookEntry.cs</strong> and click <strong>Add</strong>.</p>

<p><img src="images/1110guestbookentryclass.png?raw=true" alt="1110GuestBookEntryClass" title="GuestBookEntry Class">
</p>

<p><em>Adding the GuestBookEntry class</em></p></li>
<li><p>If not already opened, open the <strong>GuestBookEntry.cs</strong> file and then update the declaration of the <strong>GuestBookEntry</strong> class to make it public and derive from the <strong>TableServiceEntity</strong> class.</p>

<!-- mark:2 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookEntry
<strong class="markLine">    : Microsoft.WindowsAzure.Storage.Table.TableEntity</strong>
{
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> <strong>TableServiceEntity</strong> is a class found in the Storage Client API. This class defines the <strong>PartititionKey</strong>, <strong>RowKey</strong> and <strong>TimeStamp</strong> system properties required by every entity stored in a Windows Azure table. </p>

<p>Together, the <strong>PartitionKey</strong> and <strong>RowKey</strong> define the <strong>DataServiceKey</strong> that uniquely identifies every entity within a table.</p>
</blockquote></li>
<li><p>Add a default constructor to the <strong>GuestBookEntry</strong> class that initializes its <strong>PartitionKey</strong> and <strong>RowKey</strong> properties.</p>

<!-- mark:1-7 -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> GuestBookEntry()</strong>
<strong class="markLine">{            </strong>
<strong class="markLine">  PartitionKey = DateTime.UtcNow.ToString(<span style="color:#8B0000">&quot;MMddyyyy&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">  <span style="color:#008000">// Row key allows sorting, so we make sure the rows come back in time order</span></strong>
<strong class="markLine">  RowKey = <span style="color:#0000FF">string</span>.Format(<span style="color:#8B0000">&quot;{0:10}_{1}&quot;</span>, DateTime.MaxValue.Ticks - DateTime.Now.Ticks, Guid.NewGuid());</strong>
<strong class="markLine">}</strong>
</code></pre>
<blockquote>
<p><strong>Note:</strong> To partition the data, the GuestBook application uses the date of the entry as the <strong>PartitionKey</strong>, which means that there will be a separate partition for each day of guest book entries. In general, you choose the value of the partition key to ensure load balancing of the data across storage nodes.</p>

<p>The <strong>RowKey</strong> is a reverse DateTime field with a GUID appended for uniqueness. Tables within partitions are sorted in RowKey order, so this will sort the tables into the correct order to be shown on the home page, with the newest entry shown at the top.</p>
</blockquote></li>
<li><p>To complete the definition of the <strong>GuestBookEntry</strong> class, add properties for <strong>Message</strong>, <strong>GuestName</strong>, <strong>PhotoUrl</strong>, and <strong>ThumbnailUrl</strong> to hold information about the entry.</p>

<!-- mark:1-7 -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> Message { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> GuestName { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> PhotoUrl { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> ThumbnailUrl { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
</code></pre></li>
<li><p>Save the <strong>GuestBookEntry.cs</strong> file.</p></li>
<li><p>Here is the Entire Code Snippet for <em>GuestBookEntrty.cs</em></p></li>
</ol>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System;

<span style="color:#0000FF">namespace</span> GuestBook_Data
{
  <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookEntry
      : Microsoft.WindowsAzure.Storage.Table.TableEntity
  {
    <span style="color:#0000FF">public</span> GuestBookEntry()
    {
      PartitionKey = DateTime.UtcNow.ToString(<span style="color:#8B0000">&quot;MMddyyyy&quot;</span>);

      <span style="color:#008000">// Row key allows sorting, so we make sure the rows come back in time order</span>
      RowKey = <span style="color:#0000FF">string</span>.Format(<span style="color:#8B0000">&quot;{0:10}_{1}&quot;</span>, DateTime.MaxValue.Ticks - DateTime.Now.Ticks, Guid.NewGuid());
    }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> Message { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> GuestName { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> PhotoUrl { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> ThumbnailUrl { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }
  }

}
</code></pre>

<ol>
<li><p>Next, you need to create the context class required to access the <em>GuestBook</em> table using WCF Data Services. To do this, in <strong>Solution Explorer</strong>, right-click the <strong>GuestBook_Data</strong> project, point to <strong>Add</strong> and select <strong>Class</strong>. In the <strong>Add New Item</strong> dialog, set the name to <strong>GuestBookDataContext.cs</strong> and click <strong>Add</strong>.</p></li>
<li><p>In the new class file, update the declaration of the new class to make it public and inherit the <strong>TableServiceContext</strong> class.</p>

<!-- mark:2 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataContext
<strong class="markLine">    : Microsoft.WindowsAzure.Storage.Table.DataServices.TableServiceContext</strong>
{
}
</code></pre></li>
<li><p>Now, add a default constructor to initialize the base class with storage account information.</p>

<!-- mark:4-7 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataContext 
  :  Microsoft.WindowsAzure.Storage.Table.DataServices.TableServiceContext
{
<strong class="markLine">    <span style="color:#0000FF">public</span> GuestBookDataContext(Microsoft.WindowsAzure.Storage.Table.CloudTableClient client) : <span style="color:#0000FF">base</span>(client)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">    }        </strong>
<strong class="markLine">}</strong>
</code></pre>
<blockquote>
<p><strong>Note:</strong> You can find the <strong>TableServiceContext</strong> class in the storage client API. This class derives from <strong>DataServiceContext</strong> in WCF Data Services and manages the credentials required to access your storage account as well as providing support for a retry policy for its operations.</p>
</blockquote></li>
<li><p>Add a property to the <strong>GuestBookDataContext</strong> class to expose the <strong>GuestBookEntry</strong> table. To do this, insert the following (highlighted) code into the class. </p>

<!-- mark:6-12 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataContext 
  :  Microsoft.WindowsAzure.Storage.Table.DataServices.TableServiceContext
{
    ...

<strong class="markLine">    <span style="color:#0000FF">public</span> IQueryable&lt;GuestBookEntry&gt; GuestBookEntry</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">get</span></strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">return</span> <span style="color:#0000FF">this</span>.CreateQuery&lt;GuestBookEntry&gt;(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> You can use the <strong>CreateTablesFromModel</strong> method in the <strong>CloudTableClient</strong> class to create the tables needed by the application. When you supply a <strong>DataServiceContext</strong> (or <strong>TableServiceContext</strong>) derived class to this method, it locates any properties that return an <strong>IQueryable&lt;T&gt;</strong>, where the generic parameter <strong>T</strong> identifies the class that models the table schema, and creates a table in storage named after the property.</p>
</blockquote></li>
<li><p>The Entire Code Snippet for <em>GuestBookDataContext.cs</em></p></li>
</ol>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System.Linq;

<span style="color:#0000FF">namespace</span> GuestBook_Data
{
  <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataContext
    : Microsoft.WindowsAzure.Storage.Table.DataServices.TableServiceContext
  {

    <span style="color:#0000FF">public</span> GuestBookDataContext(Microsoft.WindowsAzure.Storage.Table.CloudTableClient client)
      : <span style="color:#0000FF">base</span>(client)
    {
    }

    <span style="color:#0000FF">public</span> IQueryable&lt;GuestBookEntry&gt; GuestBookEntry
    {
      <span style="color:#0000FF">get</span>
      {
        <span style="color:#0000FF">return</span> <span style="color:#0000FF">this</span>.CreateQuery&lt;GuestBookEntry&gt;(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);
      }
    }

  }
}
</code></pre>

<ol>
<li><p>Finally, you need to implement an object that can be bound to data controls in ASP.NET.  In <strong>Solution Explorer</strong>, right-click <strong>GuestBook_Data</strong>, point to <strong>Add</strong>, and select <strong>Class</strong>. In the <strong>Add New Item</strong> dialog, set the name to <strong>GuestBookDataSource.cs</strong> and click <strong>Add</strong>.</p></li>
<li><p>In the new class file, add the following namespace declarations to import the types contained in the <strong>Microsoft.WindowsAzure</strong>, <strong>Microsoft.WindowsAzure.Storage</strong> and <strong>Microsoft.WindowsAzure.Storage.Table</strong> namespaces.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Table;
</code></pre></li>
<li><p>In the <strong>GuestBookDataSource</strong> class, make the class <strong>public</strong> and define member fields for the data context and the storage account information, as shown below.</p>

<!-- mark:3-4 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudStorageAccount storageAccount;</strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> GuestBookDataContext context;</strong>
}
</code></pre></li>
<li><p>Now, add a static constructor to the data source class as shown in the following (highlighted) code. This code creates the tables from the <strong>GuestBookDataContext</strong> class.</p>

<!-- mark:5-12 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
    ...

<strong class="markLine">    <span style="color:#0000FF">static</span> GuestBookDataSource()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));</strong>
<strong class="markLine"></strong>
<strong class="markLine">        CloudTableClient cloudTableClient = storageAccount.CreateCloudTableClient();</strong>
<strong class="markLine">        CloudTable table = cloudTableClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);</strong>
<strong class="markLine">        table.CreateIfNotExists();</strong>
<strong class="markLine">    }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong>  The static  constructor initializes the storage account by reading its settings from the configuration and then uses the <strong>CreateTablesFromModel</strong> method in the <strong>CloudTableClient</strong> class to create the tables used by the application from the model defined by the <strong>GuestBookDataContext</strong> class. By using the static constructor, you ensure that this initialization task is executed only once.</p>

<p>The <strong>&quot;DataConnectionString&quot;</strong> setting will need to be created in the *.cscfg configuration files for the web roles and worker roles.  In that setting we'll need to provide a valid storage services connection string that either points to our local development storage emulator, or to a real Azure Storage account in the cloud.  We'll setup the <strong>&quot;DataConnectionString&quot;</strong> setting in a later step.</p>
</blockquote></li>
<li><p>Add a default constructor to the <strong>GuestBookDataSource</strong> class to initialize the data context class used to access table storage.</p>

<!-- mark:5-8 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
    ...

<strong class="markLine">    <span style="color:#0000FF">public</span> GuestBookDataSource()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.context = <span style="color:#0000FF">new</span> GuestBookDataContext(storageAccount.CreateCloudTableClient());</strong>
<strong class="markLine">    }</strong>
}
</code></pre></li>
<li><p>Next, insert the following method to return the contents of the <strong>GuestBookEntry</strong> table. </p>

<!-- mark:5-13 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
    ...

<strong class="markLine">    <span style="color:#0000FF">public</span> IEnumerable&lt;GuestBookEntry&gt; GetGuestBookEntries()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        CloudTableClient tableClient = storageAccount.CreateCloudTableClient();</strong>
<strong class="markLine">        CloudTable table = tableClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        TableQuery&lt;GuestBookEntry&gt; query = <span style="color:#0000FF">new</span> TableQuery&lt;GuestBookEntry&gt;().Where(TableQuery.GenerateFilterCondition(<span style="color:#8B0000">&quot;PartitionKey&quot;</span>, QueryComparisons.Equal, DateTime.UtcNow.ToString(<span style="color:#8B0000">&quot;MMddyyyy&quot;</span>)));</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> table.ExecuteQuery(query);</strong>
<strong class="markLine">    }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The <strong>GetGuestBookEntries</strong> method retrieves today's guest book entries by creating a TableQuery<t> operation that filters the retrieved information using the current date as the partition key value. The web role uses this method to bind to a data grid and display the guest book. <p>
</t></blockquote></li>
<li><p>Now, add the following method to insert new entries into the <strong>GuestBookEntry</strong> table.</p>

<!-- mark:5-10 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
    ...

<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> AddGuestBookEntry(GuestBookEntry newItem)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        TableOperation operation = TableOperation.Insert(newItem);</strong>
<strong class="markLine">        CloudTable table = context.ServiceClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);</strong>
<strong class="markLine">        table.Execute(operation);</strong>
<strong class="markLine">    }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> This method creates a <strong>TableOperation</strong> to insert the new guest book to storage.</p>
</blockquote></li>
<li><p>Finally, add a method to the data source class to update the <strong>Thumbnail URL</strong> property for an entry.</p>

<p>(Code Snippet – <em>Introduction to Cloud Services - Ex1 GuestBookDataSource UpdateImageThumbnail</em> – CS)</p>

<!-- mark:5-20 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
{
    ...

<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> UpdateImageThumbnail(<span style="color:#0000FF">string</span> partitionKey, <span style="color:#0000FF">string</span> rowKey, <span style="color:#0000FF">string</span> thumbUrl)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        CloudTable table = context.ServiceClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);</strong>
<strong class="markLine">        TableOperation retrieveOperation = TableOperation.Retrieve&lt;GuestBookEntry&gt;(partitionKey, rowKey);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        TableResult retrievedResult = table.Execute(retrieveOperation);</strong>
<strong class="markLine">        GuestBookEntry updateEntity = (GuestBookEntry)retrievedResult.Result;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (updateEntity != <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            updateEntity.ThumbnailUrl = thumbUrl;</strong>
<strong class="markLine"></strong>
<strong class="markLine">            TableOperation replaceOperation = TableOperation.Replace(updateEntity);</strong>
<strong class="markLine">            table.Execute(replaceOperation);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    } </strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The <strong>UpdateImageThumbnail</strong> method creates a table operation to retrieve an entry using its partition key and row key; it updates the thumbnail URL, creates another table operation to replace the existing guest book with the new thumbnail URL.</p>
</blockquote></li>
<li><p>Save the <strong>GuestBookDataSource.cs</strong> file.</p></li>
</ol>

<p><a name="anchor-name-here"></a>
(The Entire Code Snippet - <em>GuestBookDataSource.cs</em>)</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System;
<span style="color:#0000FF">using</span> System.Collections.Generic;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Table;

<span style="color:#0000FF">namespace</span> GuestBook_Data
{
  <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> GuestBookDataSource
  {
    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudStorageAccount storageAccount;
    <span style="color:#0000FF">private</span> GuestBookDataContext context;

    <span style="color:#0000FF">static</span> GuestBookDataSource()
    {
      storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));

      CloudTableClient cloudTableClient = storageAccount.CreateCloudTableClient();
      CloudTable table = cloudTableClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);
      table.CreateIfNotExists();
    }

    <span style="color:#0000FF">public</span> GuestBookDataSource()
    {
      <span style="color:#0000FF">this</span>.context = <span style="color:#0000FF">new</span> GuestBookDataContext(storageAccount.CreateCloudTableClient());
    }

    <span style="color:#0000FF">public</span> IEnumerable&lt;GuestBookEntry&gt; GetGuestBookEntries()
    {
      CloudTableClient tableClient = storageAccount.CreateCloudTableClient();
      CloudTable table = tableClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);

      TableQuery&lt;GuestBookEntry&gt; query = <span style="color:#0000FF">new</span> TableQuery&lt;GuestBookEntry&gt;().Where(TableQuery.GenerateFilterCondition(<span style="color:#8B0000">&quot;PartitionKey&quot;</span>, QueryComparisons.Equal, DateTime.UtcNow.ToString(<span style="color:#8B0000">&quot;MMddyyyy&quot;</span>)));

      <span style="color:#0000FF">return</span> table.ExecuteQuery(query);
    }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> AddGuestBookEntry(GuestBookEntry newItem)
    {
      TableOperation operation = TableOperation.Insert(newItem);
      CloudTable table = context.ServiceClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);
      table.Execute(operation);
    }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> UpdateImageThumbnail(<span style="color:#0000FF">string</span> partitionKey, <span style="color:#0000FF">string</span> rowKey, <span style="color:#0000FF">string</span> thumbUrl)
    {
      CloudTable table = context.ServiceClient.GetTableReference(<span style="color:#8B0000">&quot;GuestBookEntry&quot;</span>);
      TableOperation retrieveOperation = TableOperation.Retrieve&lt;GuestBookEntry&gt;(partitionKey, rowKey);

      TableResult retrievedResult = table.Execute(retrieveOperation);
      GuestBookEntry updateEntity = (GuestBookEntry)retrievedResult.Result;

      <span style="color:#0000FF">if</span> (updateEntity != <span style="color:#0000FF">null</span>)
      {
        updateEntity.ThumbnailUrl = thumbUrl;

        TableOperation replaceOperation = TableOperation.Replace(updateEntity);
        table.Execute(replaceOperation);
      }
    } 

  }
}
</code></pre>

<p><a name="Ex1Task3"></a></p>

<h4 id="Task_3__Creating_a_Web_Role_to_Display_the_Guest_Book_and_Process_User_Input">Task 3 – Creating a Web Role to Display the Guest Book and Process User Input</h4>

<p>In this task, you update the web role project that you generated in Task 1, when you created the Windows Azure Cloud Service solution. This involves updating the UI to render the list of guest book entries. For this purpose, you will find a page that has the necessary elements in the <strong>Assets</strong> folder of this exercise, which you will add to the project. Next, you implement the code necessary to store submitted entries in table storage and images in blob storage. To complete this task, you configure the storage account used by the Web role.</p>

<ol>
<li><p>Add a reference in the web role to the <strong>GuestBook</strong> project. In <strong>Solution Explorer</strong>, right-click the <strong>GuestBook_WebRole</strong> project node and select <strong>Add Reference</strong>, switch to the <strong>Solution</strong> tab, select the <strong>GuestBook_Data</strong> project, and then click <strong>OK</strong>.</p>

<p><img src="images/1120guestbookdatareference.png?raw=true" alt="1120GuestBookDataReference" title="GuestBook_Data Reference">
</p>

<p><em>Add a reference to the GuestBook_Data Project</em></p></li>
<li><p>The web role template generates a default page. You will replace it with another page that contains the UI of the guest book application. To delete the page, in <strong>Solution Explorer</strong>, <strong>right-click</strong> <strong>Default.aspx</strong> in the <strong>GuestBook_WebRole</strong> project and select <strong>Delete</strong>. Click <strong>OK</strong> in the confirmation dialog.</p>

<p><img src="images/1130deletedefaultaspx.png?raw=true" alt="1130DeleteDefaultAspx" title="Delete Default.aspx">
</p>

<p><em>Delete the original Default.aspx page</em></p></li>
<li><p>Add the main page and its associated assets to the web role. To do this, right-click <strong>GuestBook_WebRole</strong> in <strong>Solution Explorer</strong>, point to <strong>Add</strong> and select <strong>Existing Item</strong>.</p>

<p><img src="images/1140addexistingitems.png?raw=true" alt="1140AddExistingItems" title="Add Existing Items">
</p>

<p><em>Add Existing Items</em></p></li>
<li><p>In the <strong>Add Existing Item</strong> dialog, browse to the <strong>Assets</strong> folder in <strong>\Source\Assets</strong>, <strong><em>select every file in this folder</em></strong> and click <strong>Add</strong>.</p>

<p><img src="images/1150addassets.png?raw=true" alt="1150AddAssets" title="Add Assets Folder Contents">
</p>

<p><em>Add the &quot;Assets&quot; folder contents</em></p>
<blockquote>
<p><strong>Note:</strong> The <strong>Assets</strong> folder contains five files that you need to add to the project, a Default.aspx file with its code-behind and designer files, a CSS file, and an image file.</p>
</blockquote></li>
<li><p>From the <strong>GuestBook_WebnRole&quot;</strong> project, open the <strong>Default.aspx.cs&quot;</strong> code-behind file for the main page. To do this, right-click the <strong>Default.aspx</strong> file in <strong>Solution Explorer</strong> and select <strong>View Code</strong>.</p></li>
<li><p>In the code-behind file, insert the following namespace declarations.</p>

<!-- mark:1-8 -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">using</span> System.IO;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> System.Net;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure.ServiceRuntime;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Blob;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Queue;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> GuestBook_Data;</strong>
</code></pre></li>
<li><p>Declare the following member fields in the <strong>_Default</strong> class.</p>

<!-- mark:3-5 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">bool</span> storageInitialized = <span style="color:#0000FF">false</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">object</span> gate = <span style="color:#0000FF">new</span> <span style="color:#0000FF">object</span>();</strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudBlobClient blobStorage;</strong>

    ...
}
</code></pre></li>
<li><p>Locate the <strong>SignButton_Click</strong> event handler in the code-behind file and insert the following code.</p>

<!-- mark:7-28 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
    ...

    <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> SignButton_Click(<span style="color:#0000FF">object</span> sender, EventArgs e)
    {
<strong class="markLine">        <span style="color:#0000FF">if</span> (<span style="color:#0000FF">this</span>.FileUpload1.HasFile)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">this</span>.InitializeStorage();</strong>
<strong class="markLine"></strong>
<strong class="markLine">            <span style="color:#008000">// upload the image to blob storage</span></strong>
<strong class="markLine">            <span style="color:#0000FF">string</span> uniqueBlobName = <span style="color:#0000FF">string</span>.Format(<span style="color:#8B0000">&quot;guestbookpics/image_{0}{1}&quot;</span>, Guid.NewGuid().ToString(), Path.GetExtension(<span style="color:#0000FF">this</span>.FileUpload1.FileName));</strong>
<strong class="markLine">            CloudBlockBlob blob = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>).GetBlockBlobReference(uniqueBlobName);</strong>
<strong class="markLine">            blob.Properties.ContentType = <span style="color:#0000FF">this</span>.FileUpload1.PostedFile.ContentType;</strong>
<strong class="markLine">            blob.UploadFromStream(<span style="color:#0000FF">this</span>.FileUpload1.FileContent);</strong>
<strong class="markLine">            System.Diagnostics.Trace.TraceInformation(<span style="color:#8B0000">&quot;Uploaded image &#39;{0}&#39; to blob storage as &#39;{1}&#39;&quot;</span>, <span style="color:#0000FF">this</span>.FileUpload1.FileName, uniqueBlobName);</strong>
<strong class="markLine"></strong>
<strong class="markLine">            <span style="color:#008000">// create a new entry in table storage</span></strong>
<strong class="markLine">            GuestBookEntry entry = <span style="color:#0000FF">new</span> GuestBookEntry() { GuestName = <span style="color:#0000FF">this</span>.NameTextBox.Text, Message = <span style="color:#0000FF">this</span>.MessageTextBox.Text, PhotoUrl = blob.Uri.ToString(), ThumbnailUrl = blob.Uri.ToString() };</strong>
<strong class="markLine">            GuestBookDataSource ds = <span style="color:#0000FF">new</span> GuestBookDataSource();</strong>
<strong class="markLine">            ds.AddGuestBookEntry(entry);</strong>
<strong class="markLine">            System.Diagnostics.Trace.TraceInformation(<span style="color:#8B0000">&quot;Added entry {0}-{1} in table storage for guest &#39;{2}&#39;&quot;</span>, entry.PartitionKey, entry.RowKey, entry.GuestName);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.NameTextBox.Text = <span style="color:#0000FF">string</span>.Empty;</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.MessageTextBox.Text = <span style="color:#0000FF">string</span>.Empty;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.DataList1.DataBind();</strong>
    }
}

</code></pre>
<blockquote>
<p><strong>Note:</strong> To process a new guest book entry after the user submits the page, the handler first calls the <strong>InitializeStorage</strong> method to ensure that the blob container used to store images exists and allows public access. You will implement this method shortly. </p>

<p>It then obtains a reference to the blob container, generates a unique name and creates a new blob, and then uploads the image submitted by the user into this blob. Notice that the method initializes the <strong>ContentType</strong> property of the blob from the content type of the file submitted by the user. When the guest book page reads the blob back from storage, the response returns this content type, allowing a page to display the image contained in the blob simply by referring to its URL.</p>

<p>After that, it creates a new <strong>GuestBookEntry</strong> entity, which is the entity you defined in the previous task, initializes it with the information submitted by the user, and then uses the <strong>GuestBookDataSource</strong> class to save the entry to table storage using the .NET Client Library for WCF Data Services.</p>

<p>Finally, it data binds the guest book entries list to refresh its contents.</p>
</blockquote></li>
<li><p>Update the body of the <strong>Timer1_Tick</strong> method with the code shown below. </p>

<!-- mark:7 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
    ...

    <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> Timer1_Tick(<span style="color:#0000FF">object</span> sender, EventArgs e)
    {
<strong class="markLine">        <span style="color:#0000FF">this</span>.DataList1.DataBind();</strong>
    }

    ...
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The timer periodically forces the page to refresh the contents of the guest book entries list.</p>
</blockquote></li>
<li><p>Locate the <strong>Page_Load</strong> event handler and update its body with the following code to enable the page refresh timer.</p>

<!-- mark:7-10 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
    ...

    <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> Page_Load(<span style="color:#0000FF">object</span> sender, EventArgs e)
    {
<strong class="markLine">        <span style="color:#0000FF">if</span> (!Page.IsPostBack)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">this</span>.Timer1.Enabled = <span style="color:#0000FF">true</span>;</strong>
<strong class="markLine">        }</strong>
    }

    ...
}
</code></pre></li>
<li><p>Implement the <strong>InitializeStorage</strong> method by replacing its body with the following (highlighted) code.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : Page
{

    ...

     <span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> InitializeStorage()
     {
        <span style="color:#0000FF">if</span> (storageInitialized)
        {
          <span style="color:#0000FF">return</span>;
        }

        <span style="color:#0000FF">lock</span> (gate)
        {
          <span style="color:#0000FF">if</span> (storageInitialized)
          {
             <span style="color:#0000FF">return</span>;
          }

          <span style="color:#0000FF">try</span>
          {
             <span style="color:#008000">// read account configuration settings</span>
             <span style="color:#0000FF">var</span> storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));

             <span style="color:#008000">// create blob container for images</span>
             blobStorage = storageAccount.CreateCloudBlobClient();
             CloudBlobContainer container = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>);
             container.CreateIfNotExists();

             <span style="color:#008000">// configure container for public access</span>
             <span style="color:#0000FF">var</span> permissions = container.GetPermissions();
             permissions.PublicAccess = BlobContainerPublicAccessType.Container;
             container.SetPermissions(permissions);
          }
          <span style="color:#0000FF">catch</span> (WebException)
          {
             <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> WebException(<span style="color:#8B0000">&quot;Storage services initialization failure. &quot;</span>
                     + <span style="color:#8B0000">&quot;Check your storage account configuration settings. If running locally, &quot;</span>
                     + <span style="color:#8B0000">&quot;ensure that the Development Storage service is running.&quot;</span>);
          }

          storageInitialized = <span style="color:#0000FF">true</span>;
        }
     }

    ...

}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The <strong>InitializeStorage</strong> method first ensures that it executes only once. It reads the storage account settings from the Web role configuration, creates a blob container for the images uploaded with each guest book entry and configures it for public access.</p>
</blockquote></li>
<li><p>Here is the entire code for the Default.aspx.cs file:</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System;
<span style="color:#0000FF">using</span> System.IO;
<span style="color:#0000FF">using</span> System.Net;
<span style="color:#0000FF">using</span> System.Web.UI;
<span style="color:#0000FF">using</span> GuestBook_Data;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Blob;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Queue;

<span style="color:#0000FF">namespace</span> GuestBook_WebRole
{
  <span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
  {
     <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">bool</span> storageInitialized = <span style="color:#0000FF">false</span>;
     <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">object</span> gate = <span style="color:#0000FF">new</span> <span style="color:#0000FF">object</span>();
     <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudBlobClient blobStorage;

     <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> Page_Load(<span style="color:#0000FF">object</span> sender, EventArgs e)
     {
        <span style="color:#0000FF">if</span> (!Page.IsPostBack)
        {
          <span style="color:#0000FF">this</span>.Timer1.Enabled = <span style="color:#0000FF">true</span>;
        }
     }

     <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> SignButton_Click(<span style="color:#0000FF">object</span> sender, EventArgs e)
     {
        <span style="color:#0000FF">if</span> (<span style="color:#0000FF">this</span>.FileUpload1.HasFile)
        {
          <span style="color:#0000FF">this</span>.InitializeStorage();

          <span style="color:#008000">// upload the image to blob storage</span>
          <span style="color:#0000FF">string</span> uniqueBlobName = <span style="color:#0000FF">string</span>.Format(<span style="color:#8B0000">&quot;guestbookpics/image_{0}{1}&quot;</span>, Guid.NewGuid().ToString(), Path.GetExtension(<span style="color:#0000FF">this</span>.FileUpload1.FileName));
          CloudBlockBlob blob = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>).GetBlockBlobReference(uniqueBlobName);
          blob.Properties.ContentType = <span style="color:#0000FF">this</span>.FileUpload1.PostedFile.ContentType;
          blob.UploadFromStream(<span style="color:#0000FF">this</span>.FileUpload1.FileContent);
          System.Diagnostics.Trace.TraceInformation(<span style="color:#8B0000">&quot;Uploaded image &#39;{0}&#39; to blob storage as &#39;{1}&#39;&quot;</span>, <span style="color:#0000FF">this</span>.FileUpload1.FileName, uniqueBlobName);

          <span style="color:#008000">// create a new entry in table storage</span>
          GuestBookEntry entry = <span style="color:#0000FF">new</span> GuestBookEntry() { GuestName = <span style="color:#0000FF">this</span>.NameTextBox.Text, Message = <span style="color:#0000FF">this</span>.MessageTextBox.Text, PhotoUrl = blob.Uri.ToString(), ThumbnailUrl = blob.Uri.ToString() };
          GuestBookDataSource ds = <span style="color:#0000FF">new</span> GuestBookDataSource();
          ds.AddGuestBookEntry(entry);
          System.Diagnostics.Trace.TraceInformation(<span style="color:#8B0000">&quot;Added entry {0}-{1} in table storage for guest &#39;{2}&#39;&quot;</span>, entry.PartitionKey, entry.RowKey, entry.GuestName);
        }

        <span style="color:#0000FF">this</span>.NameTextBox.Text = <span style="color:#0000FF">string</span>.Empty;
        <span style="color:#0000FF">this</span>.MessageTextBox.Text = <span style="color:#0000FF">string</span>.Empty;

        <span style="color:#0000FF">this</span>.DataList1.DataBind();
     }

     <span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> Timer1_Tick(<span style="color:#0000FF">object</span> sender, EventArgs e)
     {
        <span style="color:#0000FF">this</span>.DataList1.DataBind();
     }

     <span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> InitializeStorage()
     {
        <span style="color:#0000FF">if</span> (storageInitialized)
        {
          <span style="color:#0000FF">return</span>;
        }

        <span style="color:#0000FF">lock</span> (gate)
        {
          <span style="color:#0000FF">if</span> (storageInitialized)
          {
             <span style="color:#0000FF">return</span>;
          }

          <span style="color:#0000FF">try</span>
          {
             <span style="color:#008000">// read account configuration settings</span>
             <span style="color:#0000FF">var</span> storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));

             <span style="color:#008000">// create blob container for images</span>
             blobStorage = storageAccount.CreateCloudBlobClient();
             CloudBlobContainer container = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>);
             container.CreateIfNotExists();

             <span style="color:#008000">// configure container for public access</span>
             <span style="color:#0000FF">var</span> permissions = container.GetPermissions();
             permissions.PublicAccess = BlobContainerPublicAccessType.Container;
             container.SetPermissions(permissions);
          }
          <span style="color:#0000FF">catch</span> (WebException)
          {
             <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> WebException(<span style="color:#8B0000">&quot;Storage services initialization failure. &quot;</span>
                     + <span style="color:#8B0000">&quot;Check your storage account configuration settings. If running locally, &quot;</span>
                     + <span style="color:#8B0000">&quot;ensure that the Development Storage service is running.&quot;</span>);
          }

          storageInitialized = <span style="color:#0000FF">true</span>;
        }
     }
  }
}
</code></pre></li>
<li><p>The Azure Storage libraries need to be pointed to the storage services they will use.  To do that', we'll provide the storage libraries with a &quot;connection string&quot; that it can parse to determine where the REST endpoints for the various storage services are, and to give it the account key needed to access those endpoints. In our code above we told the storage libraries to look for a *<em>&quot;DataConnectionString&quot;&quot; setting in the Cloud Service Configuration (</em>.cscfg) files.  Now, we need to create that setting and give it a value.  </p></li>
<li><p>To create a new setting, in <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node in the <strong>GuestBook</strong> cloud project, double-click <strong>GuestBook_WebRole</strong> to open the properties for this role and select the <strong>Settings</strong> tab. Click <strong>Add Setting</strong>, type <em>&quot;DataConnectionString&quot;</em> in the <strong>Name</strong> column, change the <strong>Type</strong> to <em>Connection String</em>, and then click the button labeled with an ellipsis (&quot;...&quot;)</p>

<p><img src="images/1160newsetting.png?raw=true" alt="1160NewSetting" title="NewSetting">
</p>

<p><em>Configuring the storage account settings</em></p></li>
<li><p>If prompted, sign in to your Microsoft Account:</p>

<p><img src="images/1170microsoftaccountsignin.png?raw=true" alt="1170MicrosoftAccountSignIn" title="Microsoft Account Sign In">
</p>

<p><em>Microsoft Account Sign In</em></p>
<blockquote>
<p><strong>Note:</strong> This isn't actually required right now, because we will just be pointing at the Development Storage emulator for the time being, but later when we want to point to a real Azure Storage account, signing in to your Microsoft Account helps Visual Studio show you the storage accounts you have in the cloud for easier configuration.  </p>
</blockquote></li>
<li><p>In the <strong>Create Storage Connection String</strong> dialog, choose the option labeled <strong>Windows Azure storage emulator</strong> and then click <strong>OK</strong>. </p>

<p><img src="images/1180usedevelopmentstorage.png?raw=true" alt="1180UseDevelopmentStorage" title="Use the Windows Azure storage emulator">
</p>

<p><em>Creating a connection string for the storage emulator</em> </p>
<blockquote>
<p><strong>Note:</strong> A storage account is a unique endpoint for the Windows Azure Blob, Queue, and Table services. You must create a storage account in the Management Portal to use these services. In this exercise, you use Storage emulator, which is included in the Windows Azure SDK development environment to simulate the Blob, Queue, and Table services available in the cloud. If you are building a cloud service that employs storage services or writing any external application that calls storage services, you can test locally against the Storage emulator.</p>

<p>To use the storage emulator, you set the value of the <strong>UseDevelopmentStorage</strong> keyword in the connection string for the storage account to true. When you publish your application to Windows Azure, you need to update the connection string to specify storage account settings including your account name and shared key. For example,</p>

<p>&lt;Setting name=&quot;DataConnectionString&quot; value=&quot;DefaultEndpointsProtocol=https;AccountName=YourAccountName;AccountKey=YourAccountKey&quot; /&gt;</p>

<p>where <em>YourAccountName</em> is the name of your Storage account and YourAccountKey is your access key.</p>
</blockquote></li>
<li><p>Press <strong>CTRL + S</strong> to save changes to the role configuration.</p></li>
</ol>

<p><a name="Ex1Task4"></a></p>

<h4 id="Task_4__Queuing_Work_Items_for_Background_Processing">Task 4 – Queuing Work Items for Background Processing</h4>

<p>In preparation for the next exercise, you now update the front-end web role to dispatch work items to an Azure queue for background processing. These work items will remain in the queue until you add a worker role that picks items from the queue and generates thumbnails for each uploaded image.</p>

<ol>
<li><p>Open the Default.aspx.cs code-behind file from the web role project. To do this, right-click the <strong>Default.aspx</strong> file in <strong>Solution Explorer</strong> and select <strong>View Code</strong>.</p></li>
<li><p>Declare a queue client member by inserting the following (highlighted) declaration into the <strong>Default</strong> class.</p>

<!-- mark:6 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">bool</span> storageInitialized = <span style="color:#0000FF">false</span>;
    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">object</span> gate = <span style="color:#0000FF">new</span> <span style="color:#0000FF">object</span>();
    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudBlobClient blobStorage;
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> CloudQueueClient queueStorage;</strong>

    ...
}
</code></pre></li>
<li><p>Now, update the storage initialization code to create the queue, if it does not exist, and then initialize the queue reference created in the previous step. To do this, locate the <strong>InitializeStorage</strong> method and insert the following (highlighted) code into this method immediately after the code that configures the blob container for public access.</p>

<!-- mark:13-16 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">partial</span> <span style="color:#0000FF">class</span> _Default : System.Web.UI.Page
{
    ...

    <span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> InitializeStorage()
    {
        ...

        <span style="color:#0000FF">try</span>
        {
            ...

<strong class="markLine">            <span style="color:#008000">// create queue to communicate with worker role</span></strong>
<strong class="markLine">            queueStorage = storageAccount.CreateCloudQueueClient();</strong>
<strong class="markLine">            CloudQueue queue = queueStorage.GetQueueReference(<span style="color:#8B0000">&quot;guestthumbs&quot;</span>);</strong>
<strong class="markLine">            queue.CreateIfNotExists();</strong>
        }
        <span style="color:#0000FF">catch</span> (WebException)
        {
            ...
        }

        ...
    }
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The updated code creates a queue that the web role uses to submit new jobs to the worker role.</p>
</blockquote></li>
<li><p>Finally, add code to post a work item to the queue. To do this, locate the <strong>SignButton_Click</strong> event handler and insert the following (highlighted) code immediately after the lines that create a new entry in table storage.</p>

<!-- mark:7-11 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> SignButton_Click(<span style="color:#0000FF">object</span> sender, EventArgs e)
{
    <span style="color:#0000FF">if</span> (<span style="color:#0000FF">this</span>.FileUpload1.HasFile)
    {
        ...

<strong class="markLine">        <span style="color:#008000">// queue a message to process the image</span></strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> queue = queueStorage.GetQueueReference(<span style="color:#8B0000">&quot;guestthumbs&quot;</span>);</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> message = <span style="color:#0000FF">new</span> CloudQueueMessage(<span style="color:#0000FF">string</span>.Format(<span style="color:#8B0000">&quot;{0},{1},{2}&quot;</span>, uniqueBlobName, entry.PartitionKey, entry.RowKey));</strong>
<strong class="markLine">        queue.AddMessage(message);</strong>
<strong class="markLine">        System.Diagnostics.Trace.TraceInformation(<span style="color:#8B0000">&quot;Queued message to process blob &#39;{0}&#39;&quot;</span>, uniqueBlobName);</strong>
    }

    <span style="color:#0000FF">this</span>.NameTextBox.Text = <span style="color:#0000FF">string</span>.Empty;
    <span style="color:#0000FF">this</span>.MessageTextBox.Text = <span style="color:#0000FF">string</span>.Empty;

    <span style="color:#0000FF">this</span>.DataList1.DataBind();
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> The updated code obtains a reference to the <em>“guestthumbs”</em> queue. It constructs a new message that consists of a comma-separated string with the name of the blob that contains the image, the partition key, and the row key of the entity that was added. The worker role can easily parse messages with this format. The method then submits the message to the queue.</p>
</blockquote></li>
</ol>

<p><a name="Ex1Verification"></a></p>

<h4 id="Verification">Verification</h4>

<p>The Windows Azure compute emulator, formerly Development Fabric or devfabric, is a simulated environment for developing and testing Windows Azure applications in your machine. In this task, you launch the GuestBook application in the emulator and create one or more guest book entries.</p>

<p>Among the features available in the Windows Azure Tools for Microsoft Visual Studio is a Storage browser that allows you to connect to a storage account and browse the blobs and tables it contains. If you are using this version of Visual Studio, you will use it during this task to examine the storage resources created by the application.</p>

<p>Optionally, you can use the Azure Management Studio product from Cerebrata, which includes not only a storage explorer, but also diagnostics management, deployment tools and more.  There is a 30 day free trial and you can install the application from the <a href="http://www.cerebrata.com/products/azure-management-studio/introduction">Cerebrata website</a>. </p>

<ol>
<li><p>In <strong>Visual Studio</strong>, Press <strong>F5</strong> to execute the service. The service builds and then launches the local Windows Azure compute and storage emulators. To show the Compute Emulator UI, right-click its icon located in the system tray and select <strong>Show Compute Emulator UI</strong>.</p>

<p><img src="images/1190computeemulator.png?raw=true" alt="1190ComputeEmulator" title="Compute Emulator">
</p>

<p><em>Showing the Compute Emulator UI</em></p>
<blockquote>
<p><strong>Note:</strong> If it is the first time you run the <strong>Windows Azure Emulator</strong>, the System will show a <strong>Windows Security Alert</strong> dialog indicating the Firewall has blocked some features. Click <strong>Allow Access</strong> to continue.</p>

<p><img src="Images/1200warning-unblocking-firewall.png?raw=true" alt="Unblocking the Firewall" title="Unblocking the Firewall">
</p>

<p><strong>Note:</strong> When you use the storage emulator for the first time, it needs to execute a one-time initialization procedure to create the necessary database and tables. If this is the case, wait for the procedure to complete and examine the <strong>Development Storage Initialization</strong> dialog to ensure that it completes successfully.</p>

<p><img src="Images/1210initialization-process.png?raw=true" alt="Storage emulator initialization process" title="Storage emulator initialization process">
</p>
</blockquote>
<p><em>Storage emulator initialization process</em></p></li>
<li><p>Switch to <strong>Internet Explorer</strong> to view the <strong>GuestBook</strong> application.</p></li>
<li><p>Add a new entry to the guest book. To do this, type your name and a message, choose an image to upload from the your computer (You may find some samples in the  <strong>Pictures\Sample Pictures</strong> library, or download some if you don't have any handy), and then click the pencil icon to submit the entry.</p>

<p><img src="images/1220newguestbookentry.png?raw=true" alt="1220NewGuestBookEntry" title="New Guest Book Entry">
</p>

<p><em>Windows Azure GuestBook home page</em></p>
<blockquote>
<p><strong>Note:</strong> It is a good idea to choose a large hi-resolution image because, once the application is complete, the guestbook service will resize uploaded images.</p>
</blockquote></li>
<li><p>Once you submit an entry, the web role creates a new entity in the guest book table and uploads the photo to blob storage. The page contains a timer that triggers a page refresh every 5 seconds, so the new entry should appear on the page after a brief interval. 
Initially, the new entry contains a link to the blob that contains the uploaded image so it will appear with the same size as the original image. </p>

<p><img src="images/1230largeimageinentry.png?raw=true" alt="1230LargeImageInEntry" title="Large image in entry">
</p>

<p><em>GuestBook application showing an uploaded image in its original size</em></p></li>
<li><p>To verify that the data has been saved to storage, return to Visual Studio, and open the <strong>&quot;Server Explorer&quot;</strong> Window (from the <strong>Visual Studio</strong> menu, select <strong>&quot;View&quot;</strong> | <strong>&quot;Server Explorer&quot;</strong> or use the <strong>Ctrl+W, L</strong> keyboard combination) </p></li>
<li><p>Expand the <strong>&quot;Windows Azure&quot;</strong> | <strong>&quot;Storage&quot;</strong> | <strong>&quot;(Development)&quot;</strong> node. To ensure that you are seeing the latest info, <strong>right-click</strong> on the <strong>&quot;(Development)&quot;</strong> node, and select <strong>&quot;Refresh&quot;</strong>, then click on each of the <strong>&quot;Blobs&quot;</strong>, <strong>&quot;Queues&quot;</strong>, and <strong>&quot;Tables&quot;</strong> nodes to expand them and view their contents.  </p>

<p><img src="images/1240developmentstorageinserverexplorer.png?raw=true" alt="1240DevelopmentStorageInServerExplorer" title="Development Storage in Server Explorer">
</p>

<p><em>Development Storage in Server Explorer</em></p></li>
<li><p>Next double click on the <strong>&quot;Blobs&quot;</strong> | <strong>&quot;guestbookpics&quot;</strong> container to view it's contents, then double click on the first entry in the container window to view the image you uploaded:</p>

<p><img src="images/1250blobimage.png?raw=true" alt="1250BlobImage" title="Blob Image">
</p>

<p><em>Image in Blob Storage</em></p></li>
<li><p>Next, try double clicking on the <strong>&quot;Queues&quot;</strong> | <strong>&quot;guestthumbs&quot;</strong> queue, then double clicking on the first entry to view the message (the path to the blob that needs to have a thumbnail created):</p>

<p><img src="images/1260queuemessage.png?raw=true" alt="1260QueueMessage" title="QueueMessage">
</p>

<p><em>Queue Message</em></p></li>
<li><p>Finally, double click on the <strong>&quot;Tables&quot;</strong> | <strong>&quot;GuestBookEntry&quot;</strong> table to view it's contents, and double click on the first entity to view it:</p>

<p><img src="images/1270guestbookentryentity.png?raw=true" alt="1270GuestBookEntryEntity" title="GuestBookEntry Entity">
</p></li>
<li><p>Switch to Visual Studio and Press <strong>SHIFT + F5</strong> to stop the debugger and shut down the deployment in the development fabric.</p></li>
</ol>

<hr>

<p><a name="Exercise2"></a></p>

<h3 id="Exercise_2_Background_Processing_with_Worker_Roles_and_Queues">Exercise 2: Background Processing with Worker Roles and Queues</h3>

<p>A worker role runs in the background to provide services or execute time related tasks like a service process. </p>

<p>In this exercise, you create a worker role to read work items posted to a queue by the web role front-end. To process the work item, the worker role extracts information about a guest book entry from the message and then retrieves the corresponding entity from table storage. It then fetches the associated image from blob storage and creates its thumbnail, which it also stores as a blob. Finally, to complete the processing, it updates the URL of the generated thumbnail blob in the guest book entry.</p>

<p><img src="images/0040architecture.jpg?raw=true" alt="architecture">
</p>

<ul>
<li><strong>Workflow</strong>

<ul>
<li>The <strong>web role</strong> takes in photos

<ul>
<li>It puts an entry into the table</li>
<li>It puts a message into the queue</li>
<li>It records the whole image as a blob</li>
</ul></li>
<li>The <strong>worker role</strong> is cnstantly scanning the queue to see if there is work to do

<ul>
<li>If it sees an entry, it will take the location of the blob (the photo) and make a thumbnail out of it</li>
<li>It will then update the table to reflect the cration of the thumbnail photo</li>
</ul></li>
</ul></li>
</ul>

<p><a name="Ex2Task1"></a></p>

<h4 id="Task_1__Creating_a_Worker_Role_to_Process_Images_in_the_Background">Task 1 – Creating a Worker Role to Process Images in the Background</h4>

<p>In this task, you add a worker role project to the solution and update it so that it reads items posted by the front-end from the queue and processes them.</p>

<ol>
<li><p>If not already open, launch <strong>Microsoft Visual Studio 2013</strong> as administrator. </p></li>
<li><p>You can continue working with the project you built in Exercise 1, or if needed you can open a working version of the project from the **Source\End\GuestBook-AfterExericse1&quot; folder.  </p></li>
<li><p>In <strong>Solution Explorer</strong>, right-click the Roles node in the <strong>GuestBook</strong> project and then select <strong>Add</strong> | <strong>New Worker Role Project</strong>.</p>

<p><img src="images/2020addworkerrole.png?raw=true" alt="2020AddWorkerRole" title="Add Worker Role">
</p>

<p><em>Add a worker role</em></p></li>
<li><p>In the <strong>Add New Role Project</strong> dialog, select the <strong>Worker Role</strong> category and choose the <strong>Worker Role</strong> template. Set the name of the worker role to <strong>GuestBook_WorkerRole</strong> and click <strong>Add</strong>.</p>

<p><img src="images/2030guestbookworkerrole.png?raw=true" alt="2030GuestBookWorkerRole" title="GuestBook_WorkerRole Project">
</p>

<p><em>Adding a worker role project to the solution</em></p></li>
<li><p>In the new worker role project, add a reference to the data model project. In <strong>Solution Explorer</strong>, right-click the <strong>GuestBook_WorkerRole</strong> project and select <strong>Add Reference</strong>, switch to the <strong>Solution</strong> tab, select <strong>GuestBook_Data</strong> and then click <strong>OK</strong>.</p>

<p><img src="images/2040guestbookdatareference.png?raw=true" alt="2040GuestBookDataReference" title="Add a reference to GuestBook_Data">
</p>

<p><em>GuestBook_Data Reference</em></p>
<blockquote>
<p><strong>Note</strong>  Now both the <strong>web role</strong> and the <strong>worker role</strong> have access to <strong>GuestBook_Data</strong>.</p>
</blockquote></li>
<li><p>Next, add a reference to the <strong>System.Drawing</strong> assembly, only this time, in the Add Reference dialog, switch to the <strong>Assemblies</strong> tab instead, select the <strong>System.Drawing</strong> component and then click <strong>OK</strong>.</p>

<p><img src="images/2050systemdrawingreference.png?raw=true" alt="2050SystemDrawingReference" title="System.Drawing Reference">
</p></li>
<li><p>Now, open the <strong>WorkerRole.cs</strong> file of the <strong>GuestBook_WorkerRole</strong> project and insert the followings namespace declarations.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System.Drawing;
<span style="color:#0000FF">using</span> System.Drawing.Drawing2D;
<span style="color:#0000FF">using</span> System.Drawing.Imaging;
<span style="color:#0000FF">using</span> System.IO;
<span style="color:#0000FF">using</span> GuestBook_Data;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Queue;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Blob;
</code></pre></li>
<li><p>Add member fields to the <strong>WorkerRole</strong> class for the blob container and the queue, as shown below.</p>

<!-- mark:3-4 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> WorkerRole : RoleEntryPoint
{
<strong class="markLine">    <span style="color:#0000FF">private</span> CloudQueue queue;</strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> CloudBlobContainer container;</strong>

    ...
}
</code></pre></li>
<li><p>Insert the following code into the body of the <strong>OnStart</strong> method immediately after the line that subscribes the <strong>RoleEnvironmentChanging</strong> event and before the call to the <strong>OnStart</strong> method in the base class.</p>

<!-- mark:10-58 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> WorkerRole : RoleEntryPoint
{
  ...

  <span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">bool</span> OnStart()
  {
    <span style="color:#008000">// Set the maximum number of concurrent connections </span>
    ServicePointManager.DefaultConnectionLimit = 12;

<strong class="markLine">    <span style="color:#008000">// read storage account configuration settings</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// initialize blob storage</span></strong>
<strong class="markLine">    CloudBlobClient blobStorage = storageAccount.CreateCloudBlobClient();</strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.container = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// initialize queue storage </span></strong>
<strong class="markLine">    CloudQueueClient queueStorage = storageAccount.CreateCloudQueueClient();</strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.queue = queueStorage.GetQueueReference(<span style="color:#8B0000">&quot;guestthumbs&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    Trace.TraceInformation(<span style="color:#8B0000">&quot;Creating container and queue...&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">bool</span> storageInitialized = <span style="color:#0000FF">false</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">while</span> (!storageInitialized)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">         <span style="color:#0000FF">try</span></strong>
<strong class="markLine">         {</strong>
<strong class="markLine">              <span style="color:#008000">// create the blob container and allow public access</span></strong>
<strong class="markLine">              <span style="color:#0000FF">this</span>.container.CreateIfNotExists();</strong>
<strong class="markLine">              <span style="color:#0000FF">var</span> permissions = <span style="color:#0000FF">this</span>.container.GetPermissions();</strong>
<strong class="markLine">              permissions.PublicAccess = BlobContainerPublicAccessType.Container;</strong>
<strong class="markLine">              <span style="color:#0000FF">this</span>.container.SetPermissions(permissions);</strong>
<strong class="markLine"></strong>
<strong class="markLine">              <span style="color:#008000">// create the message queue(s)</span></strong>
<strong class="markLine">              <span style="color:#0000FF">this</span>.queue.CreateIfNotExists();</strong>
<strong class="markLine"></strong>
<strong class="markLine">              storageInitialized = <span style="color:#0000FF">true</span>;</strong>
<strong class="markLine">         }</strong>
<strong class="markLine">         <span style="color:#0000FF">catch</span> (StorageException e)</strong>
<strong class="markLine">         {</strong>
<strong class="markLine">              <span style="color:#0000FF">var</span> requestInformation = e.RequestInformation;</strong>
<strong class="markLine">              <span style="color:#0000FF">var</span> errorCode = requestInformation.ExtendedErrorInformation.ErrorCode;<span style="color:#008000">//errorCode = ContainerAlreadyExists</span></strong>
<strong class="markLine">              <span style="color:#0000FF">var</span> statusCode = (System.Net.HttpStatusCode)requestInformation.HttpStatusCode;<span style="color:#008000">//requestInformation.HttpStatusCode = 409, statusCode = Conflict</span></strong>
<strong class="markLine">              <span style="color:#0000FF">if</span> (statusCode == HttpStatusCode.NotFound)</strong>
<strong class="markLine">              {</strong>
<strong class="markLine">                    Trace.TraceError(</strong>
<strong class="markLine">                      <span style="color:#8B0000">&quot;Storage services initialization failure. &quot;</span></strong>
<strong class="markLine">                      + <span style="color:#8B0000">&quot;Check your storage account configuration settings. If running locally, &quot;</span></strong>
<strong class="markLine">                      + <span style="color:#8B0000">&quot;ensure that the Development Storage service is running. Message: &#39;{0}&#39;&quot;</span>,</strong>
<strong class="markLine">                      e.Message);</strong>
<strong class="markLine">                    System.Threading.Thread.Sleep(5000);</strong>
<strong class="markLine">              }</strong>
<strong class="markLine">              <span style="color:#0000FF">else</span></strong>
<strong class="markLine">              {</strong>
<strong class="markLine">                    <span style="color:#0000FF">throw</span>;</strong>
<strong class="markLine">              }</strong>
<strong class="markLine">         }</strong>
<strong class="markLine">    }</strong>

    <span style="color:#0000FF">return</span> <span style="color:#0000FF">base</span>.OnStart();
  }
}
</code></pre></li>
<li><p>Replace the body of the <strong>Run</strong> method with the code shown below.</p>

<!-- mark:7-58 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> WorkerRole : RoleEntryPoint
{
  ...

  <span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> Run()
  {
<strong class="markLine">    Trace.TraceInformation(<span style="color:#8B0000">&quot;Listening for queue messages...&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">while</span> (<span style="color:#0000FF">true</span>)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">         <span style="color:#0000FF">try</span></strong>
<strong class="markLine">         {</strong>
<strong class="markLine">              <span style="color:#008000">// retrieve a new message from the queue</span></strong>
<strong class="markLine">              CloudQueueMessage msg = <span style="color:#0000FF">this</span>.queue.GetMessage();</strong>
<strong class="markLine">              <span style="color:#0000FF">if</span> (msg != <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">              {</strong>
<strong class="markLine">                    <span style="color:#008000">// parse message retrieved from queue</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">var</span> messageParts = msg.AsString.Split(<span style="color:#0000FF">new</span> <span style="color:#0000FF">char</span>[] { &#39;,&#39; });</strong>
<strong class="markLine">                    <span style="color:#0000FF">var</span> imageBlobName = messageParts[0];</strong>
<strong class="markLine">                    <span style="color:#0000FF">var</span> partitionKey = messageParts[1];</strong>
<strong class="markLine">                    <span style="color:#0000FF">var</span> rowkey = messageParts[2];</strong>
<strong class="markLine">                    Trace.TraceInformation(<span style="color:#8B0000">&quot;Processing image in blob &#39;{0}&#39;.&quot;</span>, imageBlobName);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                    <span style="color:#0000FF">string</span> thumbnailName = System.Text.RegularExpressions.Regex.Replace(imageBlobName, <span style="color:#8B0000">&quot;([^\\.]+)(\\.[^\\.]+)?$&quot;</span>, <span style="color:#8B0000">&quot;$1-thumb$2&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                    CloudBlockBlob inputBlob = <span style="color:#0000FF">this</span>.container.GetBlockBlobReference(imageBlobName);</strong>
<strong class="markLine">                    CloudBlockBlob outputBlob = <span style="color:#0000FF">this</span>.container.GetBlockBlobReference(thumbnailName);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                    <span style="color:#0000FF">using</span> (Stream input = inputBlob.OpenRead())</strong>
<strong class="markLine">                    <span style="color:#0000FF">using</span> (Stream output = outputBlob.OpenWrite())</strong>
<strong class="markLine">                    {</strong>
<strong class="markLine">                         <span style="color:#0000FF">this</span>.ProcessImage(input, output);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                         <span style="color:#008000">// commit the blob and set its properties</span></strong>
<strong class="markLine">                         outputBlob.Properties.ContentType = <span style="color:#8B0000">&quot;image/jpeg&quot;</span>;</strong>
<strong class="markLine">                         <span style="color:#0000FF">string</span> thumbnailBlobUri = outputBlob.Uri.ToString();</strong>
<strong class="markLine"></strong>
<strong class="markLine">                         <span style="color:#008000">// update the entry in table storage to point to the thumbnail</span></strong>
<strong class="markLine">                         GuestBookDataSource ds = <span style="color:#0000FF">new</span> GuestBookDataSource();</strong>
<strong class="markLine">                         ds.UpdateImageThumbnail(partitionKey, rowkey, thumbnailBlobUri);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                         <span style="color:#008000">// remove message from queue</span></strong>
<strong class="markLine">                         <span style="color:#0000FF">this</span>.queue.DeleteMessage(msg);</strong>
<strong class="markLine"></strong>
<strong class="markLine">                         Trace.TraceInformation(<span style="color:#8B0000">&quot;Generated thumbnail in blob &#39;{0}&#39;.&quot;</span>, thumbnailBlobUri);</strong>
<strong class="markLine">                    }</strong>
<strong class="markLine">              }</strong>
<strong class="markLine">              <span style="color:#0000FF">else</span></strong>
<strong class="markLine">              {</strong>
<strong class="markLine">                    System.Threading.Thread.Sleep(1000);</strong>
<strong class="markLine">              }</strong>
<strong class="markLine">         }</strong>
<strong class="markLine">         <span style="color:#0000FF">catch</span> (StorageException e)</strong>
<strong class="markLine">         {</strong>
<strong class="markLine">              Trace.TraceError(<span style="color:#8B0000">&quot;Exception when processing queue item. Message: &#39;{0}&#39;&quot;</span>, e.Message);</strong>
<strong class="markLine">              System.Threading.Thread.Sleep(5000);</strong>
<strong class="markLine">         }</strong>
<strong class="markLine">    }</strong>
  }

  ...
}
</code></pre></li>
<li><p>Finally, add the following method to the <strong>WorkerRole</strong> class to create thumbnails from a given image.</p>

<!-- mark:5-45 -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> WorkerRole : RoleEntryPoint
{
  ...

<strong class="markLine">  <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> ProcessImage(Stream input, Stream output)</strong>
<strong class="markLine">  {</strong>
<strong class="markLine">    <span style="color:#0000FF">int</span> width;</strong>
<strong class="markLine">    <span style="color:#0000FF">int</span> height;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> originalImage = <span style="color:#0000FF">new</span> Bitmap(input);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (originalImage.Width &gt; originalImage.Height)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">      width = 128;</strong>
<strong class="markLine">      height = 128 * originalImage.Height / originalImage.Width;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">    <span style="color:#0000FF">else</span></strong>
<strong class="markLine">    {</strong>
<strong class="markLine">      height = 128;</strong>
<strong class="markLine">      width = 128 * originalImage.Width / originalImage.Height;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    Bitmap thumbnailImage = <span style="color:#0000FF">null</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">try</span></strong>
<strong class="markLine">    {</strong>
<strong class="markLine">      thumbnailImage = <span style="color:#0000FF">new</span> Bitmap(width, height);</strong>
<strong class="markLine"></strong>
<strong class="markLine">      <span style="color:#0000FF">using</span> (Graphics graphics = Graphics.FromImage(thumbnailImage))</strong>
<strong class="markLine">      {</strong>
<strong class="markLine">        graphics.InterpolationMode = InterpolationMode.HighQualityBicubic;</strong>
<strong class="markLine">        graphics.SmoothingMode = SmoothingMode.AntiAlias;</strong>
<strong class="markLine">        graphics.PixelOffsetMode = PixelOffsetMode.HighQuality;</strong>
<strong class="markLine">        graphics.DrawImage(originalImage, 0, 0, width, height);</strong>
<strong class="markLine">      }</strong>
<strong class="markLine"></strong>
<strong class="markLine">      thumbnailImage.Save(output, ImageFormat.Jpeg);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">    <span style="color:#0000FF">finally</span></strong>
<strong class="markLine">    {</strong>
<strong class="markLine">      <span style="color:#0000FF">if</span> (thumbnailImage != <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">      {</strong>
<strong class="markLine">          thumbnailImage.Dispose();</strong>
<strong class="markLine">      }</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">  }</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> Even though the code shown above uses classes in the System.Drawing namespace for simplicity, you should be aware that the classes in this namespace were designed for use with Windows Forms. They are not supported for use within a Windows or ASP.NET service. You should conduct exhaustive testing if you intend to use these classes in your own Windows Azure applications.</p>
</blockquote></li>
<li><p>The entire code for <em>WorkerRole.cs</em></p></li>
</ol>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> GuestBook_Data;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.ServiceRuntime;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Blob;
<span style="color:#0000FF">using</span> Microsoft.WindowsAzure.Storage.Queue;
<span style="color:#0000FF">using</span> System.Diagnostics;
<span style="color:#0000FF">using</span> System.Drawing;
<span style="color:#0000FF">using</span> System.Drawing.Drawing2D;
<span style="color:#0000FF">using</span> System.Drawing.Imaging;
<span style="color:#0000FF">using</span> System.IO;
<span style="color:#0000FF">using</span> System.Net;

<span style="color:#0000FF">namespace</span> GuestBook_WorkerRole
{
  <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> WorkerRole : RoleEntryPoint
  {
    <span style="color:#0000FF">private</span> CloudQueue queue;
    <span style="color:#0000FF">private</span> CloudBlobContainer container;

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> Run()
    {
      Trace.TraceInformation(<span style="color:#8B0000">&quot;Listening for queue messages...&quot;</span>);

      <span style="color:#0000FF">while</span> (<span style="color:#0000FF">true</span>)
      {
        <span style="color:#0000FF">try</span>
        {
          <span style="color:#008000">// retrieve a new message from the queue</span>
          CloudQueueMessage msg = <span style="color:#0000FF">this</span>.queue.GetMessage();
          <span style="color:#0000FF">if</span> (msg != <span style="color:#0000FF">null</span>)
          {
            <span style="color:#008000">// parse message retrieved from queue</span>
            <span style="color:#0000FF">var</span> messageParts = msg.AsString.Split(<span style="color:#0000FF">new</span> <span style="color:#0000FF">char</span>[] { &#39;,&#39; });
            <span style="color:#0000FF">var</span> imageBlobName = messageParts[0];
            <span style="color:#0000FF">var</span> partitionKey = messageParts[1];
            <span style="color:#0000FF">var</span> rowkey = messageParts[2];
            Trace.TraceInformation(<span style="color:#8B0000">&quot;Processing image in blob &#39;{0}&#39;.&quot;</span>, imageBlobName);

            <span style="color:#0000FF">string</span> thumbnailName = System.Text.RegularExpressions.Regex.Replace(imageBlobName, <span style="color:#8B0000">&quot;([^\\.]+)(\\.[^\\.]+)?$&quot;</span>, <span style="color:#8B0000">&quot;$1-thumb$2&quot;</span>);

            CloudBlockBlob inputBlob = <span style="color:#0000FF">this</span>.container.GetBlockBlobReference(imageBlobName);
            CloudBlockBlob outputBlob = <span style="color:#0000FF">this</span>.container.GetBlockBlobReference(thumbnailName);

            <span style="color:#0000FF">using</span> (Stream input = inputBlob.OpenRead())
            <span style="color:#0000FF">using</span> (Stream output = outputBlob.OpenWrite())
            {
              <span style="color:#0000FF">this</span>.ProcessImage(input, output);

              <span style="color:#008000">// commit the blob and set its properties</span>
              outputBlob.Properties.ContentType = <span style="color:#8B0000">&quot;image/jpeg&quot;</span>;
              <span style="color:#0000FF">string</span> thumbnailBlobUri = outputBlob.Uri.ToString();

              <span style="color:#008000">// update the entry in table storage to point to the thumbnail</span>
              GuestBookDataSource ds = <span style="color:#0000FF">new</span> GuestBookDataSource();
              ds.UpdateImageThumbnail(partitionKey, rowkey, thumbnailBlobUri);

              <span style="color:#008000">// remove message from queue</span>
              <span style="color:#0000FF">this</span>.queue.DeleteMessage(msg);

              Trace.TraceInformation(<span style="color:#8B0000">&quot;Generated thumbnail in blob &#39;{0}&#39;.&quot;</span>, thumbnailBlobUri);
            }
          }
          <span style="color:#0000FF">else</span>
          {
            System.Threading.Thread.Sleep(1000);
          }
        }
        <span style="color:#0000FF">catch</span> (StorageException e)
        {
          Trace.TraceError(<span style="color:#8B0000">&quot;Exception when processing queue item. Message: &#39;{0}&#39;&quot;</span>, e.Message);
          System.Threading.Thread.Sleep(5000);
        }
      }
    }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">bool</span> OnStart()
    {
      <span style="color:#008000">// Set the maximum number of concurrent connections </span>
      ServicePointManager.DefaultConnectionLimit = 12;

      <span style="color:#008000">// read storage account configuration settings</span>
      <span style="color:#0000FF">var</span> storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));

      <span style="color:#008000">// initialize blob storage</span>
      CloudBlobClient blobStorage = storageAccount.CreateCloudBlobClient();
      <span style="color:#0000FF">this</span>.container = blobStorage.GetContainerReference(<span style="color:#8B0000">&quot;guestbookpics&quot;</span>);

      <span style="color:#008000">// initialize queue storage </span>
      CloudQueueClient queueStorage = storageAccount.CreateCloudQueueClient();
      <span style="color:#0000FF">this</span>.queue = queueStorage.GetQueueReference(<span style="color:#8B0000">&quot;guestthumbs&quot;</span>);

      Trace.TraceInformation(<span style="color:#8B0000">&quot;Creating container and queue...&quot;</span>);

      <span style="color:#0000FF">bool</span> storageInitialized = <span style="color:#0000FF">false</span>;
      <span style="color:#0000FF">while</span> (!storageInitialized)
      {
        <span style="color:#0000FF">try</span>
        {
          <span style="color:#008000">// create the blob container and allow public access</span>
          <span style="color:#0000FF">this</span>.container.CreateIfNotExists();
          <span style="color:#0000FF">var</span> permissions = <span style="color:#0000FF">this</span>.container.GetPermissions();
          permissions.PublicAccess = BlobContainerPublicAccessType.Container;
          <span style="color:#0000FF">this</span>.container.SetPermissions(permissions);

          <span style="color:#008000">// create the message queue(s)</span>
          <span style="color:#0000FF">this</span>.queue.CreateIfNotExists();

          storageInitialized = <span style="color:#0000FF">true</span>;
        }
        <span style="color:#0000FF">catch</span> (StorageException e)
        {
          <span style="color:#0000FF">var</span> requestInformation = e.RequestInformation;
          <span style="color:#0000FF">var</span> errorCode = requestInformation.ExtendedErrorInformation.ErrorCode;<span style="color:#008000">//errorCode = ContainerAlreadyExists</span>
          <span style="color:#0000FF">var</span> statusCode = (System.Net.HttpStatusCode)requestInformation.HttpStatusCode;<span style="color:#008000">//requestInformation.HttpStatusCode = 409, statusCode = Conflict</span>
          <span style="color:#0000FF">if</span> (statusCode == HttpStatusCode.NotFound)
          {
            Trace.TraceError(
              <span style="color:#8B0000">&quot;Storage services initialization failure. &quot;</span>
              + <span style="color:#8B0000">&quot;Check your storage account configuration settings. If running locally, &quot;</span>
              + <span style="color:#8B0000">&quot;ensure that the Development Storage service is running. Message: &#39;{0}&#39;&quot;</span>,
              e.Message);
            System.Threading.Thread.Sleep(5000);
          }
          <span style="color:#0000FF">else</span>
          {
            <span style="color:#0000FF">throw</span>;
          }
        }
      }

      <span style="color:#0000FF">return</span> <span style="color:#0000FF">base</span>.OnStart();
    }

    <span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> ProcessImage(Stream input, Stream output)
    {
      <span style="color:#0000FF">int</span> width;
      <span style="color:#0000FF">int</span> height;
      <span style="color:#0000FF">var</span> originalImage = <span style="color:#0000FF">new</span> Bitmap(input);

      <span style="color:#0000FF">if</span> (originalImage.Width &gt; originalImage.Height)
      {
        width = 128;
        height = 128 * originalImage.Height / originalImage.Width;
      }
      <span style="color:#0000FF">else</span>
      {
        height = 128;
        width = 128 * originalImage.Width / originalImage.Height;
      }

      Bitmap thumbnailImage = <span style="color:#0000FF">null</span>;

      <span style="color:#0000FF">try</span>
      {
        thumbnailImage = <span style="color:#0000FF">new</span> Bitmap(width, height);

        <span style="color:#0000FF">using</span> (Graphics graphics = Graphics.FromImage(thumbnailImage))
        {
          graphics.InterpolationMode = InterpolationMode.HighQualityBicubic;
          graphics.SmoothingMode = SmoothingMode.AntiAlias;
          graphics.PixelOffsetMode = PixelOffsetMode.HighQuality;
          graphics.DrawImage(originalImage, 0, 0, width, height);
        }

        thumbnailImage.Save(output, ImageFormat.Jpeg);
      }
      <span style="color:#0000FF">finally</span>
      {
        <span style="color:#0000FF">if</span> (thumbnailImage != <span style="color:#0000FF">null</span>)
        {
          thumbnailImage.Dispose();
        }
      }
    }

  }
}
</code></pre>

<ol>
<li><p>The worker role also uses Storage services and you need to configure your storage account settings, just as you did in the case of the web role. To create the storage account setting, in <strong>Solution Explorer</strong>, expand the <strong>Roles</strong> node of the <strong>GuestBook</strong> project, double-click <strong>GuestBook_WorkerRole</strong> to open the properties for this role and select the <strong>Settings</strong> tab. Click <strong>Add Setting</strong>, type <em>&quot;DataConnectionString&quot;</em> in the <strong>Name</strong> column, change the <strong>Type</strong> to <em>Connection String</em>, and then click the button labeled with an ellipsis. In the <strong>Create Storage Connection String</strong> dialog, choose the option labeled <strong>Windows Azure storage emulator</strong> and click <strong>OK</strong>. Press <strong>CTRL + S</strong> to save your changes.</p>

<p><img src="images/2060dataconnectionstring.png?raw=true" alt="2060DataConnectionString" title="DataConnectionString Setting">
</p>

<p><em>Worker Role DataConnectionString Setting</em></p></li>
</ol>

<p><a name="Ex2Verification"></a></p>

<h4 id="Verification">Verification</h4>

<p>You now launch the updated application in the Windows Azure compute emulator to verify that the worker role can retrieve queued work items and generate the corresponding thumbnails.</p>

<ol>
<li><p>Press <strong>F5</strong> to launch the service in the local compute emulator. </p></li>
<li><p>Switch to Internet Explorer to view the application. If you completed the verification section of the previous exercise successfully, you will see the guest book entry that you entered, including the uploaded image displayed in its original size. If you recall, during the last task of that exercise, you updated the web role code to post a work item to a queue for each new entry submitted. These messages remain in the queue even though the web role was subsequently recycled. </p></li>
<li><p>Wait a few seconds until the worker role picks up the queued message and processes the image that you are viewing. Once that occurs, it generates a thumbnail for this image and updates the corresponding URL property for the entry in table storage. Eventually, because the page refreshes every few seconds, it will show the thumbnail image instead.</p>

<p><img src="images/2070thumbnail.png?raw=true" alt="2070Thumbnail" title="Thumbnail created">
</p>

<p><em>Home page showing the thumbnail generated by the worker role</em></p></li>
<li><p>Back in the <strong>Visual Studio</strong> <strong>&quot;Server Explorer&quot;</strong> window, once again double click on the **&quot;guestbookpics&quot; Blob container and verify that the new thumbnail image is present. </p>

<p><img src="images/2080thumbnailinblobstorage.png?raw=true" alt="2080ThumbnailInBlobStorage" title="Thumbnail in Blob Storage">
</p>

<p><em>Blob container showing the blob for the generated thumbnail</em></p></li>
<li><p>Likewise, because the Queue Message has been processed, you should no longer see the message in the <strong>&quot;questthumbs&quot;</strong> queue</p>

<p><img src="images/2090noqueuemessages.png?raw=true" alt="2090NoQueueMessages" title="No Queue Messages">
</p>

<p><em>No queue messages</em></p></li>
<li><p>And finally, you should see that the GuestBookEntry entity has been updated with the URL to the thumbnail image:</p>

<p><img src="images/2100updatedguestbookentry.png?raw=true" alt="2100UpdatedGuestBookEntry" title="Updated GuestBookEntry Entity">
</p>

<p><em>GuestBookEntry has thumbnail url</em></p></li>
<li><p>Add some more guest book entries. Notice that the images update after a few seconds once the worker role processes the thumbnails.</p></li>
<li><p>Return to Visual Studio and press <strong>SHIFT + F5</strong> to stop the debugger and shut down the deployment in the compute emulator.</p></li>
</ol>

<hr>

<p><a name="Exercise3"></a></p>

<h3 id="Exercise_3_Publishing_a_Windows_Azure_Application">Exercise 3: Publishing a Windows Azure Application</h3>

<p>In this exercise, you publish the application created in the previous exercise to Windows Azure using the Management Portal. First, you provision the required service components, upload the application package to the staging area and configure it. You then execute the application in the staging area to verify its operation. Finally, you promote the application to production.</p>
<blockquote>
<p><strong>Note:</strong> In order to complete this exercise, you need a valid Windows Azure subscription.  If you don't have one, you can sign up for a <a href="http://aka.ms/azft">Free Trial</a></p>
</blockquote>
<p><a name="Ex3Task1"></a></p>

<h4 id="Task_1__Creating_a_Storage_Account_and_a_Cloud_Service_Component">Task 1 – Creating a Storage Account and a Cloud Service Component</h4>

<p>The application you publish in this exercise requires both compute and storage services. In this task, you create a new Windows Azure affinity group where your services will reside. In addition, you create  a new storage account to allow the application to persist its data and a cloud service component to execute application code.</p>
<blockquote>
<p><strong>Note</strong> <em>Affinity groups</em> allow you to group your Windows Azure services to optimize performance. All services within an affinity group will be located in the same data center. An affinity group is required in order to create a virtual network. You don't have to do this, but by creating a Virtual Network and Affinity group before you create your storage account and cloud service, you ensure that they will be in the same data centers, and that the Azure Fabric Controller is aware of their association with each other.  </p>
</blockquote>
<ol>
<li><p>Navigate to <a href="https://manage.windowsazure.com"><a href="https://manage.windowsazure.com">https://manage.windowsazure.com</a></a> using a web browser and sign in using the Microsoft Account associated with your Windows Azure account.</p></li>
<li><p>First, you create a new virtual network and an affinity group where your services will be deployed. In the Windows Azure menu, click <strong>NEW</strong>.</p>

<p><img src="images/3010newbutton.png?raw=true" alt="3010NewButton" title="New Button">
</p>

<p><em>New button</em></p></li>
<li><p>In the Networks menu, click <strong>Virtual Network | Custom Create</strong>.</p>

<p><img src="images/3020customcreate.png?raw=true" alt="3020CustomCreate" title="Custom Create">
</p>

<p>_Create Virtual Network</p></li>
<li><p>In the Create a Virtual Network dialog box complete the <strong>Name</strong> and in <strong>Affinity group</strong> select <em>Create a new affinity group</em>. Select the desired region and complete the <strong>Affinity Group Name</strong>. Click the arrow at the bottom of the dialog box.</p>

<p><img src="images/3030virtualnetworkdetails.png?raw=true" alt="3030VirtualNetworkDetails" title="Virtual Network Details">
</p>

<p><em>Create Virtual Network dialog box</em></p></li>
<li><p>In the DNS Servers and VPN Connectivity, leave the DNS Servers empty and click <strong>Next</strong> at the bottom of the dialog box.</p>

<p><img src="images/3040dnsservers.png?raw=true" alt="3040DNSServers" title="DNS Servers and VPN Connectivity">
</p>

<p><em>DNS Servers and VPN Connectivity</em></p></li>
<li><p>In the Virtual Network Address Spaces window, leave the default values and finish the wizard.</p>

<p><img src="images/3050addressspaces.png?raw=true" alt="3050AddressSpaces" title="Address Spaces">
</p>

<p><em>Virtual Network Address Spaces</em></p></li>
<li><p>In the <strong>Networks</strong> Tab, wait until the network status changes to <em>Created</em>.</p>

<p><img src="images/3060networkcreated.png?raw=true" alt="3060NetworkCreated" title="Network Created">
</p>

<p><em>Virtual Network Created</em></p></li>
<li><p>Now you will create the cloud service were the application will be deployed. To do so, click the <strong>NEW</strong> button at the bottom of the screen.</p>

<p><img src="images/3010newbutton.png?raw=true" alt="3010NewButton" title="New Button">
</p>

<p><em>New button</em></p></li>
<li><p>Go to <strong>Compute | Cloud Service | Quick Create</strong>. In the textbox labeled <strong>URL</strong>, enter the name for your cloud service, for example, <strong>&lt;yourname&gt;guestbook</strong>, where <em>&lt;yourname&gt;</em> is a unique name. Windows Azure uses this value to generate the endpoint URLs for the storage account services. Then, select the drop down list labeled <strong>Region/Affinity group</strong> and pick the affinity group you created in the previous step. Click <strong>Create cloud service</strong> to start creating it.</p>

<p><img src="images/3070newcloudservice.png?raw=true" alt="3070NewCloudService" title="New Cloud Service">
</p>

<p><em>New Cloud Service</em></p>
<blockquote>
<p><strong>Note:</strong> The portal ensures that the name is valid by verifying that the name complies with the naming rules and is currently available. A validation error will be shown if you enter a name that does not satisfy the rules.</p>

<p><img src="images/3080nameverification.png?raw=true" alt="3080NameVerification" title="Name Verification">
</p>

<p>Additionally, the reason that you can choose an affinity group is to deploy both the cloud service and storage account to the same location, thus ensuring high bandwidth and low latency between the application and the data it depends on.</p>
</blockquote></li>
<li><p>Next, you will create the <strong>storage account</strong> where the application will store the data. You will click the <strong>NEW</strong> button at the bottom of the screen.</p>

<p><img src="images/3010newbutton.png?raw=true" alt="3010NewButton" title="New Button">
</p>

<p><em>New button</em></p></li>
<li><p>Go to <strong>Data Services | Storage | Quick Create</strong>. In the textbox labeled <strong>URL</strong>, enter the name for your storage account, for example, <strong>&lt;yourname&gt;guestbook</strong>, where <em>&lt;yourname&gt;</em> is a unique name. Then, select the drop down list labeled <strong>Region/Affinity group</strong>, pick the affinity group you created in the previous step and click <strong>Create Storage Account</strong>. Wait until the provisioning process completes and updates the <strong>Storage</strong> list view. </p>

<p><img src="images/3090newstorageaccount.png?raw=true" alt="3090NewStorageAccount" title="New Storage Account">
</p></li>
<li><p>In the Azure portal, switch to the <strong>&quot;Storage&quot;</strong> page, and click on the line next to the name of your new storage account.  Then from the bottom, click the <strong>&quot;Manage Keys&quot;</strong> button. </p>

<p><img src="images/3100managekeys.png?raw=true" alt="3100ManageKeys" title="Manage Keys Button">
</p></li>
<li><p>At the <strong>Manage Access Keys</strong> dialog, click the <strong>&quot;copy&quot;</strong> button to the right of the <strong>&quot;PRIMARY ACCESS KEY&quot;</strong> value. If prompted to allow access to the clipboard, click <strong>&quot;Allow&quot;</strong>&quot;, the click the <strong>&quot;Check Mark&quot;</strong> button to close the <strong>&quot;Manage Access Keys&quot;</strong> window:</p>

<p><img src="images/3110manageaccesskeys.png?raw=true" alt="3110ManageAccessKeys" title="Manage Access Keys">
</p>

<p><em>Primary and Secondary Access Keys</em></p>
<blockquote>
<p><strong>Note:</strong> The <strong>Primary Access Key</strong> and <strong>Secondary Access Key</strong> both provide a shared secret that you can use to access storage. The secondary key gives the same access as the primary key and is used for backup purposes. You can regenerate each key independently in case either one is compromised.  <strong>You might want to paste the primary access key you just copied into a notepad window so you have it handy for a future step</strong>. </p>
</blockquote></li>
<li><p>Do not close the browser window. You will use the portal for the next task.</p></li>
</ol>

<p><a name="Ex3Task2"></a></p>

<h4 id="Task_2__Publishing_the_Application_to_the_Windows_Azure_Management_Portal">Task 2 – Publishing the Application to the Windows Azure Management Portal</h4>

<p>There are several alternatives for publishing applications to Windows Azure. The Windows Azure Tools for Visual Studio allow you to both create and publish the service package to the Windows Azure environment directly from Visual Studio. Another deployment option is the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156055">Windows Azure Service Management PowerShell Cmdlets</a> that enable a scripted deployment of your application. Lastly, the Windows Azure Management Portal provides the means to publish and manage your service using only your browser. For more information about publishing applications, see the <strong>Windows Azure Deployment</strong> lab in this training kit.  You can also deploy your already packaged solutions through Azure Management Studio.</p>

<p>In this task, you publish the application to the staging environment using the Management Portal but first, you generate the service package using Visual Studio.</p>

<ol>
<li><p>If it is not already open, launch <strong>Microsoft Visual Studio 2013</strong> as administrator . </p></li>
<li><p>You can either continue working with the project from the previous exercises, or if need be, you can open the solution in the <strong>&quot;Source\End\GuestBook-AfterExercise2&quot;</strong> folder.  </p></li>
<li><p>Expand the <strong>Roles</strong> folder in the <strong>GuestBook</strong> cloud project. Right-click the <strong>GuestBook_WebRole</strong> and select <strong>Properties</strong>.</p></li>
<li><p>Switch to the <strong>Settings</strong> tab and locate the <em>DataConnectionString</em> settings.</p></li>
<li><p>Click in the <strong>Ellipsis</strong> located under the <strong>Value</strong> column for the <em>DataConnectionString</em>.</p>

<p><img src="images/3110settings.png?raw=true" alt="3110Settings" title="Settings">
</p>

<p><em>DataConnectionString settings</em></p>
<blockquote>
<p><strong>Note:</strong> If you are prompted to sign in with your Microsoft Account credentials, you can do so, and then simply select your storage account from your subscription. However, you don't need to sign in to complete the following steps. </p>
</blockquote></li>
<li><p>In the <strong>Create Storage Connection String</strong> dialog box, select <strong>Manually entered credentials</strong> and complete the <strong>Account name</strong> and <strong>Account key</strong> of the storage account you've created in the previous task. Then click <strong>OK</strong> to create the storage account.</p>

<p><img src="images/3120connectionstringdetails.png?raw=true" alt="3120ConnectionStringDetails" title="ConnectionString Details">
</p>

<p><em>Create Storage Connection String</em></p>
<blockquote>
<p><strong>Note:</strong> Make sure to your YOUR storage account name and primary access key, not the values shown in the screenshot.  </p>
</blockquote></li>
<li><p>Repeat the steps above to configure the connection string for the <strong>Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</strong> in the <strong>Web Role</strong> and configure the same connection strings for the <strong>Worker Role</strong>.</p>
<blockquote>
<p><strong>Note</strong> Don't forget to do this twice, once for the <strong>Web</strong> role and again for the <strong>Worker</strong> role.</p>
</blockquote></li>
<li><p>You can actually run the application locally on your development workstation, however the application should now be using Azure Storage in the cloud, not the local storage emulator.  Go ahead and give it a try, then after you add an entry, in your <strong>Visual Studio</strong> <strong>&quot;Server Explorer&quot;</strong>, connect to your Azure account, and view the contents in storage:</p>

<p><img src="images/3130azurestorageinserverexplorer.png?raw=true" alt="3130AzureStorageInServerExplorer" title="Azure Storage in Server Explorer">
</p>
<blockquote>
<p><strong>Note:</strong> You should also notice that the sample data you had entered previously is no longer there.  That is because the sample data was on your local Development Storage Emulator, not in the cloud.  Now the app is using storage fromt the cloud, and that storage was initially empty. </p>
</blockquote></li>
<li><p>Ok, we are almost ready to push this app completely into the cloud.  The next step is to generate the package (.zip file) that has all of our compiled code, service definition, and service configuration information in it.  </p></li>
<li><p>Let's generate the package to publish to the cloud. To do this, right-click the <strong>GuestBook</strong> cloud project and select <strong>Package</strong>. </p>

<p><img src="images/3140package.png?raw=true" alt="3140Package" title="Package">
</p></li>
<li><p>In the <strong>Package Windows Azure Application</strong> dialog, select the <strong>Service Configuration</strong> and the <strong>Build Configuration</strong> you will use from the dropdowns and then click <strong>Package</strong>. </p>

<p><img src="images/3150createpackage.png?raw=true" alt="3150CreatePackage" title="Create Package">
</p>

<p><em>Creating a service package in Visual Studio</em></p>

<p>After Visual Studio builds the project and generates the service package, Windows Explorer opens with the current folder set to the location where the generated package is stored.  Copy the path to the output folder to your clipboard. We'll need that in the next step when we upload the package:</p>

<p><img src="images/3160packagefolder.png?raw=true" alt="3160PackageFolder" title="Package Folder">
</p>

<p><em>Package Folder</em></p>
<blockquote>
<p><strong>Note:</strong> Although the procedure is not shown here, you can use the Publish Cloud Service feature in the Windows Azure Tools to publish your service package directly from Visual Studio. To use this feature, you need to configure a set of credentials that you use to authenticate access to the management service using a self-issued certificate that you upload to the Management Portal.</p>
</blockquote></li>
<li><p>Now, switch back to the browser window with the Management Portal opened.</p></li>
<li><p>In the cloud services list, click the name of the cloud service that you created before.</p>

<p><img src="images/3170cloudservice.png?raw=true" alt="3170CloudService" title="Cloud Service">
</p>

<p><em>Cloud Service</em></p></li>
<li><p>In the <strong>Dashboard</strong> page, click <strong>Staging</strong> and then <strong>Upload a New Staging Environment</strong>. </p>

<p><img src="images/3180uploadtostaging.png?raw=true" alt="3180UploadToStaging" title="UploadToStaging">
</p>

<p><em>Deploy to staging environment</em></p>
<blockquote>
<p><strong>Note:</strong> A cloud service is a service that runs your code in the Windows Azure environment. It has two separate deployment slots: staging and production. The staging deployment slot allows you to test your service in the Windows Azure environment before you deploy it to production.</p>
</blockquote></li>
<li><p>In the <strong>Upload a Package</strong> dialog, enter a label to identify the deployment; for example, use <strong>FirstVersion</strong>.</p>
<blockquote>
<p><strong>Note:</strong> The portal displays the label in its user interface for staging and production, allowing you to identify the version currently deployed in each environment.</p>
</blockquote></li>
<li><p>To select the <strong>Package</strong> from the file system, click <strong>From Local</strong>, navigate to the folder where Visual Studio generated the package then select <strong>GuestBook.cspkg</strong>. </p></li>
<li><p>Now, to choose the <strong>Configuration</strong> file, click <strong>From Local</strong> and select <strong>ServiceConfiguration.cscfg</strong> in the same folder that you used in the previous step.</p>
<blockquote>
<p><strong>Note:</strong> The <em>.cscfg</em> file contains configuration settings for the application, including the instance count that you will update later in the exercise.</p>
</blockquote></li>
<li><p>Finally, check the option labeled <strong>Deploy even if one or more roles contain a single instance</strong>. Click the <strong>Tick</strong> to start the deployment. </p>
<blockquote>
<p><strong>Note1:</strong> This checkbox is important. Don't forget.</p>

<p><strong>Note2:</strong> In this particular case, only a single instance is being deployed for at least one of the roles. This is not recommended because it does not guarantee the service’s availability. In the next task, you will increase the number of instances to overcome this issue.</p>
</blockquote>
<p><img src="images/3190uploadapackage.png?raw=true" alt="3190UploadAPackage" title="Upload a Package">
</p>

<p><em>Upload package to staging</em></p></li>
<li><p>Notice that the package begins to upload and that the portal shows the status of the deployment to indicate its progress. </p>

<p><img src="images/3200status.png?raw=true" alt="3200Status" title="Status">
</p>

<p><em>Uploading cloud service</em></p></li>
<li><p>Wait until the deployment process finishes, which may take several minutes. Once the <strong>&quot;STATUS&quot;</strong> reads <strong>&quot;Running&quot;</strong>, Notice the <strong>Site Url</strong> assigned to your deployment under the <strong>quick glance</strong> section.</p>

<p><img src="images/3210stagedservice.png?raw=true" alt="3210StagedService" title="Staged Service">
</p>

<p><em>Staged Service</em></p>
<blockquote>
<p><strong>Note</strong> You can use the dashboard to verify progress.</p>

<p>During deployment, Windows Azure analyzes the configuration file and copies the service to the correct number of machines, and starts all the instances. Load balancers, network devices and monitoring are also configured during this time.</p>

<p>Your new cloud service has a <strong>DNS name</strong> asigned, an URL that points to your web role home page.</p>
</blockquote></li>
</ol>

<p><a name="Ex3Task3"></a></p>

<h4 id="Task_3__Configuring_the_Application_to_Increase_the_Number_of_Instances">Task 3 – Configuring the Application to Increase the Number of Instances</h4>

<p>Once your application is deployed you can make certain changes, like channging the number of instances of each role, while the service is live.  </p>

<ol>
<li><p>In <strong>Cloud Services</strong>, click on your <strong>GuestBook</strong> service and click <strong>Scale</strong> on the ribbon.</p>

<p><img src="images/3330scalepage.png?raw=true" alt="3330ScalePage" title="Scale Page">
</p>

<p><em>Scaling instances</em></p></li>
<li><p>On the <strong>Scale</strong> page, view the number of instances for the GuestBook_WebRole:</p>

<p><img src="images/3340guestbookwebroleinstances.png?raw=true" alt="3340GuestBookWebRoleInstances" title="GuestBook_WebRole Instances">
</p>

<p><em>GuestBook_WebRole Instances</em></p>
<blockquote>
<p><strong>Note:</strong> Alternatively, you can change the instance count entering the new number into the text boxes at right.</p>

<p>This setting controls the number of roles that Windows Azure starts and is used to scale the service. For a token-based subscription—currently only available in countries that are not provisioned for billing—this number is limited to a maximum of two instances. However, in the commercial offering, you can change it to any number that you are willing to pay for.</p>
</blockquote></li>
<li><p>Drag the <strong>INSTANCE COUNT</strong> slider to 2 and click the <strong>&quot;SAVE&quot;</strong> button along the bottom:</p>

<p><img src="images/3350changeinstancecount.png?raw=true" alt="3350ChangeInstanceCount" title="Change Instance Count">
</p>

<p><em>Saving the instance count</em></p></li>
<li><p>Wait for the Scale operation to complete before continuing:</p>

<p><img src="images/3360scalestatus.png?raw=true" alt="3360ScaleStatus" title="Scale Status">
</p></li>
</ol>

<p><a name="Ex3Task4"></a></p>

<h4 id="Task_4__Testing_the_Application_in_the_Staging_Environment">Task 4 – Testing the Application in the Staging Environment</h4>

<p>In this task, you run the application in the staging environment and access its public endpoint to test that it operates correctly.</p>

<ol>
<li><p>Go to your cloud service's <strong>dashboard</strong> and then click the <strong>Site Url</strong> link under the <strong>quick glance</strong> section.</p>

<p><img src="images/3370siteurl.png?raw=true" alt="3370SiteUrl" title="Site URL">
</p>

<p><em>Site URL</em></p>
<blockquote>
<p><strong>Note:</strong> The link shown for Site URL name has the form <em>&lt;guid&gt;.cloudapp.net</em>, where <em><guid></guid></em> is some random identifier. This is different from the address where the application will run once it is in production. Although the application executes in a staging area that is separate from the production environment, there is no actual physical difference between staging and production – it is simply a matter of where the load balancer is connected. </p>
</blockquote></li>
<li><p>If you wish, you may test the application by signing the guest book and uploading an image.</p>

<p><img src="images/3380stagingsite.png?raw=true" alt="3380StagingSite" title="Staging Site">
</p>

<p><em>Application running in the staging environment</em></p></li>
</ol>

<p><a name="Ex3Task5"></a></p>

<h4 id="Task_5__Promoting_the_Application_to_Production">Task 5 – Promoting the Application to Production</h4>

<p>Now that you have verified that the service is working correctly in the staging environment, you are ready to promote it to final production. When you deploy the application to production, Windows Azure reconfigures its load balancers so that the application is available at its production URL.</p>

<ol>
<li><p>In <strong>Cloud Services</strong>, click on your service and then click <strong>Swap</strong> at the bottom menu.</p>

<p><img src="images/3390vipswap.png?raw=true" alt="3390VIPSwap" title="VIP Swap">
</p>

<p><em>Swap slots</em></p></li>
<li><p>On the <strong>VIP Swap</strong> dialog, click <strong>Yes</strong> to swap the deployments between staging and production.</p>

<p><img src="images/3400confirmswap.png?raw=true" alt="3400ConfirmSwap" title="Confirm VIP Swap">
</p>

<p><em>Promoting the application to the production slot</em></p></li>
<li><p>Wait for the promotion process to complete.</p>

<p><img src="images/3410swapstatus.png?raw=true" alt="3410SwapStatus" title="Swap Status">
</p>

<p><em>Swapping deployments</em></p></li>
<li><p>When the promotion process is complete, you will no longer have a <strong>&quot;Staging&quot;</strong> deployment:</p>

<p><img src="images/3420nostaging.png?raw=true" alt="3420NoStaging" title="No Staging Deployment">
</p>

<p><em>No Staging Deployment</em></p></li>
<li><p>Switch to the <strong>&quot;Production&quot;</strong> page and verify that there is an active deployment.  Scroll down and click the <strong>Site URL</strong> link to open the production site in a browser window and notice the URL in the address bar.</p>

<p><img src="images/3430productiondeployment.png?raw=true" alt="3430ProductionDeployment" title="ProductionDeployment">
</p>

<p><em>Production Deployment</em></p></li>
<li><p>Verify that the site loads correctly from the Production URL: </p>

<p><img src="images/3440productionsite.png?raw=true" alt="3440ProductionSite" title="Production Site">
</p>
<blockquote>
<p><strong>Note:</strong> If you visit the production site shortly after its promotion, the DNS name might not be ready. If you encounter a DNS error (404), wait a few minutes and try again. Keep in mind that Windows Azure creates DNS name entries dynamically and that the changes might take few minutes to propagate.</p>
</blockquote></li>
<li><p>Even when a deployment is in a suspended state, Windows Azure still needs to allocate a virtual machine for each instance and charge you for it. Once you have completed testing the application, you need to remove the deployment from Windows Azure to avoid an unnecessary expense. To remove a running deployment, go to <strong>Cloud Services</strong>, select the deployment slot where the service is currently hosted, staging or production, then click <strong>Stop</strong> on the bottom pane and accept the confirmation prompt. Once the service has stopped, click <strong>Delete</strong> on the bottom pane and click <strong>Delete the production deployment for cloud service yourusernameguestbook</strong> to remove it.</p>

<p><img src="images/4010deleteserviceanddeployments.png?raw=true" alt="4010DeleteServiceAndDeployments" title="Delete the Cloud Service and it's Deployments">
</p>

<p><em>Delete the cloud service and all its deployments to prevent being charged</em></p></li>
</ol>

<hr>

<p><a name="summary"></a></p>

<h2 id="Summary">Summary</h2>

<p>By completing this hands-on lab, you have reviewed the basic elements of Windows Azure applications. You have seen that services consist of one or more web roles and worker roles. You have learned about Storage services and in particular, Blob, Table and Queue services. Finally, you have explored a basic architectural pattern for cloud applications that allows front-end processes to communicate with back-end processes using queues.</p>

</div>
</body>
</html>
